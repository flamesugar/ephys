<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of SCRATCH_AutoClass2</title>
  <meta name="keywords" content="SCRATCH_AutoClass2">
  <meta name="description" content="% AutoClass Scratch">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">spike_sorting</a> &gt; SCRATCH_AutoClass2.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for spike_sorting&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>SCRATCH_AutoClass2
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>% AutoClass Scratch</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">% AutoClass Scratch
 Preliminary structure to new spike classification scheme

 1) Online detected spikes(or offline using ss_detect)
 2) Align spikes by maximum negative peak (ss_align)
 3) Run principal component analysis on aligned waveforms
 4) Run AutoClass on aligned waveforms (AutoClass2)
 5) Save data for Pooling

 Pooling GUI specs:
 1) Plot waveforms of AutoClass classes
   1.1) Optionally plot color coded raw waveforms of selected classes
   1.2) Optionally plot color coded mean +/- std waveforms as bands
 2) View PCA results as projections of 1 vs 2, 1 vs 3, 2 vs 3 dimensions
   2.1) Optional 2D and 3D scatter plots of PCA scores
   2.2) Optional plot as density map (2D only)
 3) ISI for selected classes
 4) Cross/autocorrelation of selected classes
 5) Fit gaussian to negative peak amplitude from detection threshold in
 order to estimate number of undetected spikes of the selected class


 DJS 2012</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AutoClass2.html" class="code" title="function cfg = AutoClass2(W,cfg)">AutoClass2</a>	cfg = AutoClass2(W,cfg)</li><li><a href="AutoClassReport2.html" class="code" title="function result = AutoClassReport2(SnipFile)">AutoClassReport2</a>	result = AutoClassReport2(SnipFile)</li><li><a href="ss_align.html" class="code" title="function spikes = ss_align( spikes )">ss_align</a>	UltraMegaSort2000 by Hill DN, Mehta SB, & Kleinfeld D  - 07/12/2010</li><li><a href="ss_default_params.html" class="code" title="function spikes = ss_default_params(Fs, varargin )">ss_default_params</a>	UltraMegaSort2000 by Hill DN, Mehta SB, & Kleinfeld D  - 07/12/2010</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% AutoClass Scratch</span>
0002 <span class="comment">% Preliminary structure to new spike classification scheme</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% 1) Online detected spikes(or offline using ss_detect)</span>
0005 <span class="comment">% 2) Align spikes by maximum negative peak (ss_align)</span>
0006 <span class="comment">% 3) Run principal component analysis on aligned waveforms</span>
0007 <span class="comment">% 4) Run AutoClass on aligned waveforms (AutoClass2)</span>
0008 <span class="comment">% 5) Save data for Pooling</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Pooling GUI specs:</span>
0011 <span class="comment">% 1) Plot waveforms of AutoClass classes</span>
0012 <span class="comment">%   1.1) Optionally plot color coded raw waveforms of selected classes</span>
0013 <span class="comment">%   1.2) Optionally plot color coded mean +/- std waveforms as bands</span>
0014 <span class="comment">% 2) View PCA results as projections of 1 vs 2, 1 vs 3, 2 vs 3 dimensions</span>
0015 <span class="comment">%   2.1) Optional 2D and 3D scatter plots of PCA scores</span>
0016 <span class="comment">%   2.2) Optional plot as density map (2D only)</span>
0017 <span class="comment">% 3) ISI for selected classes</span>
0018 <span class="comment">% 4) Cross/autocorrelation of selected classes</span>
0019 <span class="comment">% 5) Fit gaussian to negative peak amplitude from detection threshold in</span>
0020 <span class="comment">% order to estimate number of undetected spikes of the selected class</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% DJS 2012</span>
0024 
0025 
0026 [TANKS,OK] = TDT_TankSelect(<span class="string">'SelectionMode'</span>,<span class="string">'multiple'</span>);
0027 
0028 <span class="keyword">if</span> ~OK, <span class="keyword">return</span>; <span class="keyword">end</span>
0029 
0030 cfg = [];
0031 <span class="comment">% cfg.blocks   = 5;</span>
0032 cfg.blocks   = <span class="string">'all'</span>;
0033 cfg.datatype = <span class="string">'Spikes'</span>;
0034 cfg.event    = <span class="string">'eNeu'</span>;
0035 <span class="comment">% cfg.datatype = 'Stream';</span>
0036 
0037 
0038 <span class="comment">% Maximum number of AutoClass threads to launch at once.  Usually set to</span>
0039 <span class="comment">% number of processors - 1</span>
0040 NThreads = 7; 
0041 
0042 <span class="keyword">for</span> tind = 1:length(TANKS)
0043     [~,TANKS{tind},~] = fileparts(TANKS{tind});
0044     cfg.tank = TANKS{tind};
0045     [data,scfg] = getTankData(cfg);
0046     
0047     Fs = scfg.fsample;
0048     
0049     <span class="keyword">if</span> isfield(data,<span class="string">'waves'</span>)
0050         <span class="comment">% filter for spikes</span>
0051         fprintf(<span class="string">'filtering for spikes ... '</span>)
0052         h = fdesign.bandpass(<span class="string">'Fst1,Fp1,Fp2,Fst2,Ast1,Ap,Ast2'</span>, <span class="keyword">...</span>
0053             300,500,5000,10000,18,0.1,18,Fs);
0054         d1 = design(h,<span class="string">'butter'</span>);
0055         sig = filtfilt(d1.sosMatrix,d1.ScaleValues,double(data.waves));
0056         
0057         <span class="comment">% compute common average reference (Ludwig et al, 2009)</span>
0058         sig = sig - repmat(mean(sig,2),1,size(sig,2));
0059         
0060         fprintf(<span class="string">'done\n'</span>)
0061         
0062         <span class="comment">% Spikes detected offline</span>
0063         fprintf(<span class="string">'detecting spikes ... '</span>)
0064         spikes = DetectSpikesQ(sig,Fs);
0065         fprintf(<span class="string">'done\n'</span>)
0066     <span class="keyword">else</span>
0067         spikes = data; clear data
0068     <span class="keyword">end</span>
0069     
0070     <span class="keyword">for</span> i = 1:length(spikes) <span class="comment">% run AutoClass one channel at a time</span>
0071         fprintf(<span class="string">'Running Channel %d (%d of %d)\n'</span>,spikes(i).channel,i,length(spikes))
0072         
0073         cfg.Spikes = spikes(i);
0074         cfg.TankCFG  = scfg;
0075         cfg.AutoClass.resultsdir = [<span class="string">'D:\AutoClass_Files\AC2_RESULTS\'</span> cfg.tank <span class="string">'\'</span>];
0076         cfg.AutoClass.fileroot   = sprintf(<span class="string">'%s_%03.0f'</span>,cfg.tank,spikes(i).channel);
0077         cfg.PCA.filename = fullfile(cfg.AutoClass.resultsdir,[cfg.AutoClass.fileroot <span class="string">'_PCA.mat'</span>]);
0078         
0079         <span class="keyword">if</span> ~isdir(cfg.AutoClass.resultsdir), mkdir(cfg.AutoClass.resultsdir); <span class="keyword">end</span>
0080         
0081         k = [];
0082         <span class="keyword">for</span> j = 1:length(spikes(i).waveforms)
0083             <span class="keyword">if</span> isempty(spikes(i).waveforms{j})
0084                 k(end+1) = j; <span class="comment">%#ok&lt;SAGROW&gt;</span>
0085             <span class="keyword">end</span>
0086         <span class="keyword">end</span>
0087         spikes(i).waveforms(k)  = [];
0088         spikes(i).timestamps(k) = [];
0089         
0090         W = cell2mat(spikes(i).waveforms');
0091         T = cell2mat(spikes(i).timestamps')';
0092         
0093         <span class="keyword">if</span> isempty(W),<span class="keyword">continue</span>; <span class="keyword">end</span>
0094         
0095         <span class="comment">% set defaults for alignment function</span>
0096         s = <a href="ss_default_params.html" class="code" title="function spikes = ss_default_params(Fs, varargin )">ss_default_params</a>(Fs);
0097         s.waveforms = W;
0098         
0099         <span class="comment">% Align Spikes by negative peak</span>
0100         s.info = [];
0101         s.spiketimes = T;
0102         s.params.max_jitter = 0.3;
0103         s.info.detect.align_sample = 9;
0104         s.info.detect.event_channel = ones(size(W,1),1);
0105         s = <a href="ss_align.html" class="code" title="function spikes = ss_align( spikes )">ss_align</a>(s);
0106         W = s.waveforms;    
0107                 
0108         <span class="comment">% Run PCA on aligned spikes</span>
0109         fprintf(<span class="string">'\t&gt; Running PCA on aligned waveforms\n'</span>)
0110         [coeffs,scores,latent] = princomp(W);
0111         
0112         fprintf(<span class="string">'\t&gt; Saving PCA results\n'</span>)
0113         save(cfg.PCA.filename,<span class="string">'coeffs'</span>,<span class="string">'scores'</span>,<span class="string">'latent'</span>);
0114         
0115         
0116         cfg.AutoClass.wrappedtimestamps = s.spiketimes;
0117         
0118         clear s
0119         
0120         <span class="comment">% Append some info to cfg structure</span>
0121         cfg.spiketotal = size(W,1);
0122         
0123         
0124         <span class="comment">% wait for processors to open up</span>
0125         <span class="keyword">while</span> 1
0126             [~,b] = dos(<span class="string">'tasklist /fi &quot;IMAGENAME eq Autoclass.exe&quot;'</span>);
0127             numthreads = length(strfind(b,<span class="string">'Autoclass'</span>));
0128             <span class="keyword">if</span> numthreads &lt; NThreads, <span class="keyword">break</span>; <span class="keyword">end</span>
0129             pause(1)
0130         <span class="keyword">end</span>
0131         
0132         <span class="comment">% close any cmd.exe windows which have completed running Autoclass.exe</span>
0133         [~,b] = dos(<span class="string">'taskkill /fi &quot;WINDOWTITLE eq Administrator: C:\Windows\SYSTEM32\cmd.exe&quot;'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
0134         
0135         <span class="comment">% Run AutoClass on aligned spikes</span>
0136         <span class="comment">%     cfg.AutoClass.variance_factor (default = 2)</span>
0137         cfg = <a href="AutoClass2.html" class="code" title="function cfg = AutoClass2(W,cfg)">AutoClass2</a>(W,cfg);
0138         
0139     <span class="keyword">end</span>
0140 <span class="keyword">end</span>
0141 
0142 numthreads = 1;
0143 <span class="keyword">while</span> numthreads
0144     [~,b] = dos(<span class="string">'tasklist /nh /fi &quot;IMAGENAME eq Autoclass.exe&quot;'</span>);
0145     numthreads = length(strfind(b,<span class="string">'Autoclass'</span>));
0146     pause(1)
0147 <span class="keyword">end</span>
0148 
0149 <span class="comment">% close any cmd.exe windows which have completed running Autoclass.exe</span>
0150 [~,b] = dos(<span class="string">'taskkill /fi &quot;WINDOWTITLE eq Administrator: C:\Windows\SYSTEM32\cmd.exe&quot;'</span>);
0151 
0152 fprintf(<span class="string">'Finished classifying: %s\n'</span>,datestr(now));
0153 fprintf(<span class="string">'Remember to run the AutoClass Reporting utility before using the Pooling GUI\n\n'</span>)
0154 
0155 <span class="comment">%% Run AutoClass Reporting utility</span>
0156 <span class="comment">% * Only run after all channels have finished being processed with AutoClass</span>
0157 
0158 <span class="keyword">for</span> t = TANKS
0159     
0160     resultsdir = [<span class="string">'D:\AutoClass_Files\AC2_RESULTS\'</span> t <span class="string">'\'</span>];
0161     
0162     d = dir(resultsdir);
0163     k = findincell(strfind({d.name},<span class="string">'SNIP'</span>));
0164     d = d(k);
0165     
0166     <span class="keyword">for</span> j = 1:length(d)
0167         f = fullfile(resultsdir,d(j).name);
0168         <a href="AutoClassReport2.html" class="code" title="function result = AutoClassReport2(SnipFile)">AutoClassReport2</a>(f);
0169     <span class="keyword">end</span>    
0170 <span class="keyword">end</span>
0171 fprintf(<span class="string">'\n\n*** We''re all done here ***\n\n'</span>)</pre></div>
<hr><address>Generated on Wed 24-Jul-2013 19:48:12 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>