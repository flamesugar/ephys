<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of Pooling_GUI2</title>
  <meta name="keywords" content="Pooling_GUI2">
  <meta name="description" content="Pooling_GUI2">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">spike_sorting</a> &gt; Pooling_GUI2.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for spike_sorting&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>Pooling_GUI2
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Pooling_GUI2</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function varargout = Pooling_GUI2(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Pooling_GUI2
 
 DJS 2011</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AutoClass2TDT.html" class="code" title="function AutoClass2TDT(poolfn,varargin)">AutoClass2TDT</a>	AutoClass2TDT(poolfn)</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function Pooling_GUI2_OpeningFcn(hObject, eventdata, handles, varargin)</a></li><li><a href="#_sub2" class="code">function varargout = Pooling_GUI2_OutputFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub3" class="code">function figure1_CloseRequestFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub4" class="code">function OpenDataset(DATAFILEIDX)</a></li><li><a href="#_sub5" class="code">function t = ChooseClassedData</a></li><li><a href="#_sub6" class="code">function datafiles = GetDatasets(t)</a></li><li><a href="#_sub7" class="code">function h = LoadDataset(datafile,h)</a></li><li><a href="#_sub8" class="code">function SavePools(h)</a></li><li><a href="#_sub9" class="code">function b = EnsurePoolsSaved(h)</a></li><li><a href="#_sub10" class="code">function PlotClasses(h)</a></li><li><a href="#_sub11" class="code">function EditClass(hObj,evnt,cid)</a></li><li><a href="#_sub12" class="code">function PlotPools(h)</a></li><li><a href="#_sub13" class="code">function PlotPCA(h)</a></li><li><a href="#_sub14" class="code">function PlotTime(h)</a></li><li><a href="#_sub15" class="code">function PlotAnalytics(h,results)</a></li><li><a href="#_sub16" class="code">function ChangePlotOrder(hObj,evnt,hl,ax)</a></li><li><a href="#_sub17" class="code">function suc = GetSelectedUnitClasses(h)</a></li><li><a href="#_sub18" class="code">function results = ComputeAnalytics(timestamps)</a></li><li><a href="#_sub19" class="code">function UIPCA(hObj,evnt,opt)</a></li><li><a href="#_sub20" class="code">function SelectClass(hObj,evnt)</a></li><li><a href="#_sub21" class="code">function SelectPool(hObj,event)</a></li><li><a href="#_sub22" class="code">function UpdateUnitType(hObj,evnt,ax,classid)</a></li><li><a href="#_sub23" class="code">function UpdateClassInfo(h)</a></li><li><a href="#_sub24" class="code">function UpdateChannel(h,chandir)</a></li><li><a href="#_sub25" class="code">function UpdatePlotStyle(h)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = Pooling_GUI2(varargin)</a>
0002 <span class="comment">% Pooling_GUI2</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% DJS 2011</span>
0005 
0006 <span class="comment">% Begin initialization code - DO NOT EDIT</span>
0007 gui_Singleton = 1;
0008 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0009                    <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0010                    <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub1" class="code" title="subfunction Pooling_GUI2_OpeningFcn(hObject, eventdata, handles, varargin) ">Pooling_GUI2_OpeningFcn</a>, <span class="keyword">...</span>
0011                    <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub2" class="code" title="subfunction varargout = Pooling_GUI2_OutputFcn(hObject, eventdata, handles)  ">Pooling_GUI2_OutputFcn</a>, <span class="keyword">...</span>
0012                    <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0013                    <span class="string">'gui_Callback'</span>,   []);
0014 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0015     gui_State.gui_Callback = str2func(varargin{1});
0016 <span class="keyword">end</span>
0017 
0018 <span class="keyword">if</span> nargout
0019     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0020 <span class="keyword">else</span>
0021     gui_mainfcn(gui_State, varargin{:});
0022 <span class="keyword">end</span>
0023 <span class="comment">% End initialization code - DO NOT EDIT</span>
0024 
0025 <span class="comment">% --- Executes just before Pooling_GUI2 is made visible.</span>
0026 <a name="_sub1" href="#_subfunctions" class="code">function Pooling_GUI2_OpeningFcn(hObject, eventdata, handles, varargin) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0027 <span class="comment">% Choose default command line output for Pooling_GUI2</span>
0028 handles.output = hObject;
0029 
0030 <span class="comment">% handles.regKey = 'HKCU\Software\MATHWORKS\MATLAB\Pooling';</span>
0031 <span class="comment">% t = GetRegKey(handles.regKey,'SPIKEPLOTTYPE');</span>
0032 t = getpref(<span class="string">'Pooling_GUI2'</span>,<span class="string">'SPIKEPLOTTYPE'</span>,[]);
0033 <span class="keyword">if</span> isempty(t), t = <span class="string">'off'</span>; <span class="keyword">end</span>
0034 set(handles.toolbar_bands,<span class="string">'State'</span>,t);
0035 
0036 handles.POOLIDS{1} = <span class="string">'Noise'</span>;
0037 handles.POOLIDS{2} = <span class="string">'MU'</span>;
0038 <span class="keyword">for</span> i = 1:10
0039     handles.POOLIDS{2+i} = num2str(i,<span class="string">'SU%d'</span>);
0040 <span class="keyword">end</span>
0041 
0042 handles.POOLS_SAVED = true;
0043 
0044 handles.DATAFILEIDX = [];
0045 
0046 uim = uicontextmenu;
0047 uimenu(uim,<span class="string">'Label'</span>,<span class="string">'Plot 3D'</span>,<span class="string">'Tag'</span>,<span class="string">'PCA_3D'</span>, <span class="keyword">...</span>
0048     <span class="string">'Checked'</span>,<span class="string">'on'</span>,<span class="string">'Callback'</span>,{@<a href="#_sub19" class="code" title="subfunction UIPCA(hObj,evnt,opt) ">UIPCA</a>,<span class="string">'3D'</span>});
0049 uimenu(uim,<span class="string">'Label'</span>,<span class="string">'Plot Projections'</span>,<span class="string">'Tag'</span>,<span class="string">'PCA_2D'</span>, <span class="keyword">...</span>
0050     <span class="string">'Separator'</span>,<span class="string">'on'</span>,<span class="string">'Callback'</span>,{@<a href="#_sub19" class="code" title="subfunction UIPCA(hObj,evnt,opt) ">UIPCA</a>,<span class="string">'2D'</span>});
0051 uimenu(uim,<span class="string">'Label'</span>,<span class="string">' &gt; Plot as Density'</span>,<span class="string">'Tag'</span>,<span class="string">'PCA_2D_DENSITY'</span>, <span class="keyword">...</span>
0052     <span class="string">'Callback'</span>,{@<a href="#_sub19" class="code" title="subfunction UIPCA(hObj,evnt,opt) ">UIPCA</a>,<span class="string">'Density'</span>});
0053 set(handles.panel_pca,<span class="string">'uicontextmenu'</span>,uim);
0054 
0055 
0056 guidata(hObject, handles);
0057 
0058 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0059 <a name="_sub2" href="#_subfunctions" class="code">function varargout = Pooling_GUI2_OutputFcn(hObject, eventdata, handles)  </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0060 varargout{1} = handles.output;
0061 
0062 <a name="_sub3" href="#_subfunctions" class="code">function figure1_CloseRequestFcn(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSL,DEFNU&gt;</span>
0063 <span class="keyword">if</span> strcmp(<a href="#_sub9" class="code" title="subfunction b = EnsurePoolsSaved(h)">EnsurePoolsSaved</a>(handles),<span class="string">'Cancel'</span>), <span class="keyword">return</span>; <span class="keyword">end</span>
0064 
0065 t = get(handles.toolbar_bands,<span class="string">'State'</span>);
0066 <span class="comment">% SetRegKey(handles.regKey,'SPIKEPLOTTYPE',t);</span>
0067 setpref(<span class="string">'Pooling_GUI2'</span>,<span class="string">'SPIKEPLOTTYPE'</span>,t);
0068 
0069 <span class="comment">% Hint: delete(hObject) closes the figure</span>
0070 delete(hObject);
0071 
0072 
0073 
0074 
0075 
0076 
0077 
0078 
0079 
0080 
0081 
0082 
0083 
0084 
0085 <span class="comment">%% Load Classes</span>
0086 <a name="_sub4" href="#_subfunctions" class="code">function OpenDataset(DATAFILEIDX)</a>
0087 h = guidata(gcbo);
0088 
0089 set(gcf,<span class="string">'Pointer'</span>,<span class="string">'watch'</span>);
0090 
0091 <span class="keyword">if</span> ~exist(<span class="string">'DATAFILEIDX'</span>,<span class="string">'var'</span>) || isempty(DATAFILEIDX)
0092     DATAFILEIDX = 1;
0093     t = <a href="#_sub5" class="code" title="subfunction t = ChooseClassedData">ChooseClassedData</a>;
0094     <span class="keyword">if</span> ~t, <span class="keyword">return</span>; <span class="keyword">end</span>
0095     h.DATAFILES = <a href="#_sub6" class="code" title="subfunction datafiles = GetDatasets(t)">GetDatasets</a>(t);
0096 <span class="keyword">end</span>
0097 
0098 h.DATAFILEIDX = DATAFILEIDX;
0099 h.DATAFILE = h.DATAFILES(h.DATAFILEIDX).cfg;
0100 h.CHANNELS = zeros(size(h.DATAFILES));
0101 <span class="keyword">for</span> i = 1:length(h.DATAFILES)
0102     h.CHANNELS(i) = h.DATAFILES(i).cfg.Spikes.channel;
0103 <span class="keyword">end</span>
0104 h = <a href="#_sub7" class="code" title="subfunction h = LoadDataset(datafile,h)">LoadDataset</a>(h.DATAFILE,h);
0105 
0106 chstr = sprintf(<span class="string">'%d,'</span>,h.DATAFILE.Spikes.channel); chstr(end) = [];
0107 <span class="keyword">if</span> length(h.DATAFILE.Spikes.channel) &gt; 1, polystr = <span class="string">'Polytrode'</span>; <span class="keyword">else</span> polystr = <span class="string">'Channel'</span>; <span class="keyword">end</span>
0108 set(h.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'Pooling: %s | %s %s (%d of %d)'</span>, <span class="keyword">...</span>
0109     h.DATAFILE.tank,polystr,chstr,DATAFILEIDX,length(h.DATAFILES)));
0110 
0111 <a href="#_sub10" class="code" title="subfunction PlotClasses(h)">PlotClasses</a>(h);
0112 <a href="#_sub13" class="code" title="subfunction PlotPCA(h)">PlotPCA</a>(h);
0113 <a href="#_sub14" class="code" title="subfunction PlotTime(h)">PlotTime</a>(h);
0114 <a href="#_sub12" class="code" title="subfunction PlotPools(h)">PlotPools</a>(h);
0115 <a href="#_sub23" class="code" title="subfunction UpdateClassInfo(h)">UpdateClassInfo</a>(h);
0116 a = get(h.panel_analytics,<span class="string">'Children'</span>);
0117 delete(a);
0118 
0119 <span class="comment">% Enable toolbar</span>
0120 th = findobj(gcbf,<span class="string">'-regexp'</span>,<span class="string">'Tag'</span>,<span class="string">'toolbar*'</span>, <span class="keyword">...</span>
0121     <span class="string">'-and'</span>,<span class="string">'-not'</span>,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>, <span class="keyword">...</span>
0122     <span class="string">'-and'</span>,<span class="string">'-not'</span>,<span class="string">'Tag'</span>,<span class="string">'toolbar_open'</span>);
0123 
0124 set(th,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0125 
0126 h.POOLS_SAVED = true;
0127 <a href="#_sub24" class="code" title="subfunction UpdateChannel(h,chandir)">UpdateChannel</a>(h);
0128 h.POOLS_SAVED = false;
0129 
0130 guidata(h.figure1,h);
0131 
0132 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);
0133 
0134 <a name="_sub5" href="#_subfunctions" class="code">function t = ChooseClassedData</a>
0135 <span class="comment">% returns tank directory</span>
0136 h = guidata(gcf); <span class="comment">%#ok&lt;NASGU&gt;</span>
0137 
0138 <span class="comment">% d = GetRegKey(h.regKey,'acdir');</span>
0139 d = getpref(<span class="string">'Pooling_GUI2'</span>,<span class="string">'acdir'</span>,[]);
0140 <span class="keyword">if</span> ~exist(<span class="string">'d'</span>,<span class="string">'var'</span>) || isempty(d), d = []; <span class="keyword">end</span>
0141 
0142 t = uigetdir(d,<span class="string">'Choose tank'</span>);
0143 
0144 <span class="keyword">if</span> ~t, <span class="keyword">return</span>; <span class="keyword">end</span>
0145 
0146 <span class="comment">% SetRegKey(h.regKey,'acdir',t);</span>
0147 setpref(<span class="string">'Pooling_GUI2'</span>,<span class="string">'acdir'</span>,t);
0148 
0149 <a name="_sub6" href="#_subfunctions" class="code">function datafiles = GetDatasets(t)</a>
0150 <span class="comment">% Get filenames of classed datasets</span>
0151 <span class="comment">%</span>
0152 <span class="comment">% fn is the full file name and path to the &quot;Classed_Spikes_...&quot; file from</span>
0153 <span class="comment">% a call to AutoClassReport2</span>
0154 
0155 <span class="keyword">if</span> t(end) ~= <span class="string">'\'</span>, t(end+1) = <span class="string">'\'</span>; <span class="keyword">end</span>
0156 
0157 classed_files = dir([t <span class="string">'*_CLASSES.mat'</span>]);
0158 
0159 <span class="keyword">if</span> isempty(classed_files), error(<span class="string">'No classed data found'</span>); <span class="keyword">end</span>
0160 <span class="comment">% classed_files = {classed_files.name};</span>
0161 
0162 cfgfile = dir([t <span class="string">'\*_SNIP.mat'</span>]);
0163 cfgfile = {cfgfile.name};
0164 
0165 <span class="comment">% find available channels</span>
0166 <span class="keyword">for</span> i = 1:length(cfgfile)
0167     load(fullfile(t,cfgfile{i}),<span class="string">'cfg'</span>);
0168     datafiles(i).cfg = cfg; <span class="comment">%#ok&lt;AGROW&gt;</span>
0169     cf = [t cfg.AutoClass.fileroot <span class="string">'_CLASSES.mat'</span>];
0170     <span class="keyword">if</span> ~exist(cf,<span class="string">'file'</span>)
0171         fprintf(<span class="string">'** WARNING: Class file was not found: ''%s''\n'</span>,cf)
0172     <span class="keyword">end</span>
0173     datafiles(i).cfg.AutoClass.classed = cf; <span class="comment">%#ok&lt;AGROW&gt;</span>
0174 <span class="keyword">end</span>
0175 
0176 <a name="_sub7" href="#_subfunctions" class="code">function h = LoadDataset(datafile,h)</a>
0177 <span class="comment">% Where datafile is one index from the structure returned from a call to</span>
0178 <span class="comment">% GetDatasets</span>
0179 cstr = sprintf(<span class="string">'%d,'</span>,datafile.Spikes.channel); cstr(end) = [];
0180 s = sprintf(<span class="string">'Loading: Tank ''%s'' Channel %s'</span>,datafile.tank,cstr);
0181 fprintf(<span class="string">'%s ...'</span>,s);
0182 set(h.figure1,<span class="string">'Name'</span>,s);
0183 
0184 set(h.figure1,<span class="string">'pointer'</span>,<span class="string">'watch'</span>); drawnow
0185 
0186 <span class="comment">% load waveform data</span>
0187 load(datafile.AutoClass.snipsfn);
0188 h.WAVEFORMS = W;
0189 
0190 <span class="comment">% load PCA results</span>
0191 h.PCA = [];
0192 <span class="keyword">if</span> isfield(datafile,<span class="string">'PCA'</span>) &amp;&amp; exist(datafile.PCA.filename,<span class="string">'file'</span>)
0193     h.PCA = load(datafile.PCA.filename);
0194 <span class="keyword">end</span>
0195 
0196 <span class="comment">% load AutoClass results</span>
0197 load(datafile.AutoClass.classed);
0198 h.CFG = cfg;
0199 <span class="comment">% h.BLOCKLIST = cfg.SpikeBlockID;</span>
0200 h.BLOCKLIST = cfg.blocks;
0201 h.CLASSLIST = classList; <span class="comment">%#ok&lt;NODEF&gt;</span>
0202 h.UCLASSES  = unique(classList(2,:));
0203 
0204 set(h.panel_classes,<span class="string">'Title'</span>, <span class="keyword">...</span>
0205     sprintf(<span class="string">'Classes: %d classes based on %d spikes'</span>, <span class="keyword">...</span>
0206     length(h.UCLASSES),size(h.CLASSLIST,2)));
0207 
0208 tw = cfg.Spikes.timestamps;
0209 ts = zeros(sum(cfg.Spikes.blockspikes),1);
0210 ts(1:cfg.Spikes.blockspikes(1)) = tw{1};
0211 k = cfg.Spikes.blockspikes(1)+1;
0212 <span class="keyword">for</span> i = 2:length(tw)
0213     ts(k:k+length(tw{i})-1) = tw{i}+ts(k-1);
0214     k = sum(cfg.Spikes.blockspikes(1:i))+1;
0215 <span class="keyword">end</span>
0216 h.TS_WRAPPED   = cell2mat(tw');
0217 h.TS_UNWRAPPED = ts;
0218 
0219 
0220 chstr = sprintf(<span class="string">'%d_'</span>,datafile.Spikes.channel); chstr(end) = [];
0221 <span class="keyword">if</span> length(datafile.Spikes.channel) &gt; 1
0222     polystr = sprintf(<span class="string">'PTRODE%d'</span>,h.DATAFILEIDX);
0223 <span class="keyword">else</span>
0224     polystr = sprintf(<span class="string">'Ch_%s'</span>,chstr);
0225 <span class="keyword">end</span>
0226 datafile.pools = sprintf(<span class="string">'%s\\%s_%s_POOLS.mat'</span>, <span class="keyword">...</span>
0227     h.CFG.AutoClass.resultsdir,datafile.tank,polystr);
0228 
0229 
0230 <span class="comment">% load Pools (if already exist)</span>
0231 <span class="keyword">if</span> exist(datafile.pools,<span class="string">'file'</span>)
0232     load(datafile.pools);
0233     h.POOLS = POOLS;
0234     h.CLASSLIST = CLASSLIST; <span class="comment">%#ok&lt;NODEF&gt;</span>
0235     h.UCLASSES = unique(CLASSLIST(2,:));
0236     h.POOLS_SAVED = true;
0237 <span class="keyword">else</span>
0238     h.POOLS = zeros(1,size(h.CLASSLIST,2));
0239     h.POOLS_SAVED = false;
0240 <span class="keyword">end</span>
0241 
0242 set(h.figure1,<span class="string">'pointer'</span>,<span class="string">'arrow'</span>);
0243 fprintf(<span class="string">'done\n'</span>)
0244 
0245 
0246 
0247 
0248 
0249 
0250 
0251 
0252 
0253 
0254 
0255 <span class="comment">%% Save Pools</span>
0256 <a name="_sub8" href="#_subfunctions" class="code">function SavePools(h)</a>
0257 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'watch'</span>); drawnow
0258 
0259 <span class="comment">% Save pooled data with classed data</span>
0260 POOLS     = h.POOLS; <span class="comment">%#ok&lt;NASGU&gt;</span>
0261 CLASSLIST = h.CLASSLIST; <span class="comment">%#ok&lt;NASGU&gt;</span>
0262 
0263 chstr = sprintf(<span class="string">'%d_'</span>,h.DATAFILE.Spikes.channel); chstr(end) = [];
0264 <span class="keyword">if</span> length(h.DATAFILE.Spikes.channel) &gt; 1
0265     polystr = sprintf(<span class="string">'PTRODE%d'</span>,h.DATAFILEIDX);
0266 <span class="keyword">else</span>
0267     polystr = sprintf(<span class="string">'Ch_%s'</span>,chstr);
0268 <span class="keyword">end</span>
0269 poolstr = sprintf(<span class="string">'%s\\%s_%s_POOLS.mat'</span>, <span class="keyword">...</span>
0270     h.CFG.AutoClass.resultsdir,h.DATAFILE.tank,polystr);
0271 
0272 save(poolstr,<span class="string">'POOLS'</span>,<span class="string">'CLASSLIST'</span>);
0273 
0274 <span class="keyword">if</span> exist(poolstr,<span class="string">'file'</span>)
0275     fprintf(<span class="string">'Saved: %s | %s %s\n'</span>,h.DATAFILE.tank,polystr,chstr)
0276 <span class="keyword">else</span>
0277     fprintf(<span class="string">'\n*** UNABLE TO SAVE POOLS! ***\n'</span>)
0278 <span class="keyword">end</span>
0279 
0280 
0281 <a href="AutoClass2TDT.html" class="code" title="function AutoClass2TDT(poolfn,varargin)">AutoClass2TDT</a>(poolstr)
0282 
0283 
0284 h.POOLS_SAVED = true;
0285 guidata(gcbo,h);
0286 
0287 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);
0288 
0289 
0290 <a name="_sub9" href="#_subfunctions" class="code">function b = EnsurePoolsSaved(h)</a>
0291 <span class="keyword">if</span> h.POOLS_SAVED
0292     b = <span class="string">'Continue'</span>;
0293 <span class="keyword">else</span>
0294     b = questdlg([<span class="string">'Pools have been modified.  '</span>, <span class="keyword">...</span>
0295         <span class="string">'Would you like to save the current pools?'</span>], <span class="keyword">...</span>
0296         <span class="string">'Save Pools'</span>,<span class="string">'Save'</span>,<span class="string">'Continue'</span>,<span class="string">'Cancel'</span>,<span class="string">'Save'</span>);
0297     <span class="keyword">switch</span> b
0298         <span class="keyword">case</span> <span class="string">'Cancel'</span>
0299             <span class="keyword">return</span>
0300         <span class="keyword">case</span> <span class="string">'Save'</span>
0301             <a href="#_sub8" class="code" title="subfunction SavePools(h)">SavePools</a>(h);
0302     <span class="keyword">end</span>
0303 <span class="keyword">end</span>
0304 
0305 
0306 
0307 
0308 
0309 
0310 
0311 
0312 
0313 
0314 
0315 
0316 <span class="comment">%% Plotting functions</span>
0317 <a name="_sub10" href="#_subfunctions" class="code">function PlotClasses(h)</a>
0318 W  = h.WAVEFORMS;
0319 C  = h.CLASSLIST;
0320 uc = h.UCLASSES;
0321 colors = hsv(length(h.UCLASSES));
0322 
0323 t = get(h.toolbar_bands,<span class="string">'State'</span>);
0324 <span class="keyword">if</span> strcmp(t,<span class="string">'on'</span>)
0325     opt = <span class="string">'bands'</span>;
0326 <span class="keyword">else</span>
0327     opt = <span class="string">'lines'</span>;
0328 <span class="keyword">end</span>
0329 
0330 nrows = floor(sqrt(length(uc)));
0331 ncols = ceil(length(uc) / nrows);
0332 <span class="keyword">if</span> nrows &lt; 2, nrows = 2; <span class="keyword">end</span>
0333 
0334 <span class="comment">% scale together by maximum absolute voltage</span>
0335 maxV = max(abs(W),[],2);
0336 maxV = quantile(maxV,0.999);
0337 
0338 delete(get(h.panel_classes,<span class="string">'Children'</span>));
0339 
0340 ax = zeros(size(uc));
0341 <span class="keyword">for</span> i = 1:length(uc)
0342     ax(i) = subplot(nrows,ncols,i,<span class="string">'Parent'</span>,h.panel_classes, <span class="keyword">...</span>
0343         <span class="string">'Tag'</span>,num2str(uc(i),<span class="string">'axclass%02.0f'</span>));
0344     
0345     ind = C(2,:) == uc(i);
0346         
0347     <span class="keyword">if</span> sum(ind) &lt;= 1
0348         op = <span class="string">'lines'</span>;
0349     <span class="keyword">else</span>
0350         op = opt;
0351     <span class="keyword">end</span>
0352     
0353     <span class="keyword">switch</span> op
0354         <span class="keyword">case</span> <span class="string">'lines'</span>
0355             <span class="comment">% if lots of lines, then just display a random sampling</span>
0356             <span class="keyword">if</span> sum(ind) &gt; 500, ind = find(ind); ind = ind(randperm(500)); <span class="keyword">end</span>
0357             plot(ax(i),1:size(W,2),W(ind,:)',<span class="string">'Color'</span>,colors(i,:))
0358        
0359         <span class="keyword">case</span> <span class="string">'bands'</span>
0360             q = quantile(W(ind,:),[0.025 0.975])';
0361             y = [q(:,1); flipud(q(:,2))];
0362             x = [1:size(W,2) size(W,2):-1:1];
0363             fill(x',y,colors(i,:),<span class="string">'Parent'</span>,ax(i));
0364     <span class="keyword">end</span>
0365     xlim(ax(i),[1 size(W,2)]);  ylim(ax(i),[-maxV maxV]);
0366     
0367     uim = uicontextmenu(<span class="string">'UserData'</span>,uc(i));
0368     uimenu(uim,<span class="string">'Label'</span>,<span class="string">'Select Class'</span>,<span class="string">'Tag'</span>,<span class="string">'Select_Class'</span>,<span class="string">'UserData'</span>,uc(i), <span class="keyword">...</span>
0369         <span class="string">'Checked'</span>,<span class="string">'off'</span>,<span class="string">'Callback'</span>,{@<a href="#_sub20" class="code" title="subfunction SelectClass(hObj,evnt) ">SelectClass</a>});
0370     uimenu(uim,<span class="string">'Label'</span>,<span class="string">'Edit Class'</span>,<span class="string">'Tag'</span>,<span class="string">'Edit_Class'</span>,<span class="string">'UserData'</span>,uc(i), <span class="keyword">...</span>
0371         <span class="string">'Callback'</span>,{@<a href="#_sub11" class="code" title="subfunction EditClass(hObj,evnt,cid) ">EditClass</a>,uc(i)});
0372     <span class="keyword">for</span> j = 1:length(h.POOLIDS)
0373         <span class="keyword">if</span> j == 1, s = <span class="string">'on'</span>; <span class="keyword">else</span> s = <span class="string">'off'</span>; <span class="keyword">end</span>
0374         uimenu(uim,<span class="string">'Label'</span>,h.POOLIDS{j},<span class="string">'Tag'</span>,[<span class="string">'ut_'</span> lower(h.POOLIDS{j})], <span class="keyword">...</span>
0375             <span class="string">'UserData'</span>,j-1,<span class="string">'Checked'</span>,<span class="string">'on'</span>,<span class="string">'Separator'</span>,s, <span class="keyword">...</span>
0376             <span class="string">'Callback'</span>,{@<a href="#_sub22" class="code" title="subfunction UpdateUnitType(hObj,evnt,ax,classid) ">UpdateUnitType</a>,ax(i),uc(i)});
0377     <span class="keyword">end</span>
0378     
0379     set(ax(i),<span class="string">'UIContextMenu'</span>,uim);
0380     set(ax(i),<span class="string">'ButtonDownFcn'</span>,@<a href="#_sub20" class="code" title="subfunction SelectClass(hObj,evnt) ">SelectClass</a>);
0381     set(ax(i),<span class="string">'UserData'</span>,uc(i),<span class="string">'XGrid'</span>,<span class="string">'on'</span>,<span class="string">'XMinorGrid'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0382         <span class="string">'YGrid'</span>,<span class="string">'on'</span>,<span class="string">'YMinorGrid'</span>,<span class="string">'off'</span>,<span class="string">'YTickLabel'</span>,[],<span class="string">'XTickLabel'</span>,[], <span class="keyword">...</span>
0383         <span class="string">'Box'</span>,<span class="string">'on'</span>);
0384 <span class="keyword">end</span>
0385 
0386 x = (nrows-1)*ncols+1;
0387 <span class="keyword">if</span> x &gt; length(ax); x =(nrows-2)*ncols+1; <span class="keyword">end</span>
0388 yt = get(ax(x),<span class="string">'YTick'</span>);
0389 set(ax(x),<span class="string">'YTickLabel'</span>,num2str((yt)'*1000,<span class="string">'%0.2f'</span>));
0390 
0391 <span class="comment">% SetRegKey(h.regKey,'PLOTSPIKESSTYLE',opt);</span>
0392 setpref(<span class="string">'Pooling_GUI2'</span>,<span class="string">'PLOTSPIKESSTYLE'</span>,opt);
0393 
0394 <a name="_sub11" href="#_subfunctions" class="code">function EditClass(hObj,evnt,cid) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0395 h = guidata(hObj);
0396 W  = h.WAVEFORMS;
0397 C  = h.CLASSLIST;
0398 uc = h.UCLASSES;
0399 <span class="comment">% colors = hsv(length(h.UCLASSES));</span>
0400 
0401 ind = C(2,:) == cid;
0402 orind = find(ind);
0403 sW = W(ind,:);
0404 
0405 <span class="comment">% uid = uc == cid;</span>
0406 
0407 f = figure(<span class="string">'Name'</span>,sprintf(<span class="string">'Class ID: %d | %d spikes'</span>,cid,sum(ind)));
0408 
0409 ax = axes(<span class="string">'Parent'</span>,f,<span class="string">'XGrid'</span>,<span class="string">'on'</span>,<span class="string">'YGrid'</span>,<span class="string">'on'</span>,<span class="string">'XTickLabel'</span>,[]);
0410 
0411 hl = line(repmat((1:size(sW,2))',1,size(sW,1)),sW', <span class="keyword">...</span>
0412     <span class="string">'Parent'</span>,ax);
0413 <span class="comment">% hl = line(repmat((1:size(sW,2))',1,size(sW,1)),sW', ...</span>
0414 <span class="comment">%     'Parent',ax,'Color',colors(uid,:));</span>
0415 
0416 maxV = max(max(abs(sW)));
0417 ylim(ax,[-maxV maxV]); xlim(ax,[1 size(sW,2)]);
0418 ylabel(ax,<span class="string">'Amp (V)'</span>);
0419 
0420 hold(ax,<span class="string">'on'</span>);
0421 [xa,ya] = ginput(1); xa = round(xa); plot(ax,xa,ya,<span class="string">'xk'</span>);
0422 [xb,yb] = ginput(1); xb = round(xb); plot(ax,xb,yb,<span class="string">'xk'</span>);
0423 x = min([xa xb]); xb = max([xa xb]); xa = x;
0424 y = min([ya yb]); yb = max([ya yb]); ya = y;
0425 
0426 xl = [xa xa xb xb xa]; yl = [ya yb yb ya ya];
0427 plot(ax,xl,yl,<span class="string">'--k'</span>);
0428 hold(ax,<span class="string">'off'</span>);
0429 
0430 ind = any(sW(:,xa:xb) &gt;= ya &amp; sW(:,xa:xb) &lt;= yb,2);
0431 
0432 set(hl(ind),<span class="string">'LineWidth'</span>,3);
0433 set(hl(~ind),<span class="string">'Color'</span>,<span class="string">'k'</span>,<span class="string">'LineStyle'</span>,<span class="string">':'</span>);
0434 
0435 r = questdlg(sprintf(<span class="string">'%d spikes have been selected.  Would you like to create a new class with these spikes?'</span>, <span class="keyword">...</span>
0436     sum(ind)),<span class="string">'Split Class'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0437 
0438 <span class="keyword">if</span> strcmp(r,<span class="string">'No'</span>), close(f); <span class="keyword">return</span>; <span class="keyword">end</span>
0439 
0440 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'watch'</span>); set(f,<span class="string">'Pointer'</span>,<span class="string">'watch'</span>); drawnow
0441 
0442 C(:,orind(ind)) = max(uc) + 1;
0443 
0444 h.CLASSLIST = C;
0445 h.UCLASSES  = unique(C(2,:));
0446 
0447 guidata(hObj,h);
0448 
0449 close(f);
0450 
0451 <a href="#_sub10" class="code" title="subfunction PlotClasses(h)">PlotClasses</a>(h);
0452 <a href="#_sub23" class="code" title="subfunction UpdateClassInfo(h)">UpdateClassInfo</a>(h);
0453 <a href="#_sub13" class="code" title="subfunction PlotPCA(h)">PlotPCA</a>(h);
0454 <a href="#_sub14" class="code" title="subfunction PlotTime(h)">PlotTime</a>(h);
0455 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);
0456 
0457 <a name="_sub12" href="#_subfunctions" class="code">function PlotPools(h)</a>
0458 W  = h.WAVEFORMS;
0459 P  = h.POOLS;
0460 up = unique(P);
0461 colors = lines(7);
0462 
0463 t = get(h.toolbar_bands,<span class="string">'State'</span>);
0464 <span class="keyword">if</span> strcmp(t,<span class="string">'on'</span>)
0465     opt = <span class="string">'bands'</span>;
0466 <span class="keyword">else</span>
0467     opt = <span class="string">'lines'</span>;
0468 <span class="keyword">end</span>
0469 
0470 delete(get(h.panel_pools,<span class="string">'Children'</span>));
0471 
0472 <span class="keyword">if</span> isempty(P), <span class="keyword">return</span>; <span class="keyword">end</span>
0473 
0474 ind = ismember(P,up);
0475 maxV = max(abs(W(ind,:)),[],2);
0476 maxV = quantile(maxV,0.9999);
0477 
0478 <span class="keyword">if</span> length(up) &lt; 3, ncol = 3; <span class="keyword">else</span> ncol = length(up); <span class="keyword">end</span>
0479 
0480 <span class="keyword">for</span> i = 1:length(up)
0481     ax = subplot(1,ncol,i,<span class="string">'Parent'</span>,h.panel_pools);
0482     
0483     ind = up(i) == P;
0484     nc = sum(ind);
0485     <span class="keyword">switch</span> opt
0486         <span class="keyword">case</span> <span class="string">'lines'</span>
0487             <span class="comment">% if lots of lines, then just display a random subsample</span>
0488             <span class="keyword">if</span> nc &gt; 1000, ind = find(ind); ind = ind(randperm(1000)); <span class="keyword">end</span>
0489             plot(ax,1:size(W,2),W(ind,:)',<span class="string">'Color'</span>,colors(i,:))    
0490             
0491         <span class="keyword">case</span> <span class="string">'bands'</span>
0492             q = quantile(W(ind,:),[0.025 0.975])';
0493             y = [q(:,1); flipud(q(:,2))];
0494             x = [1:size(W,2) size(W,2):-1:1];
0495             fill(x',y,colors(i,:),<span class="string">'Parent'</span>,ax);
0496     <span class="keyword">end</span>
0497 
0498     xlim(ax,[1 size(W,2)]);
0499     ylim(ax,[-maxV maxV]);
0500     
0501     <span class="keyword">if</span> i == 1
0502         yt = get(ax,<span class="string">'YTick'</span>);
0503         set(ax,<span class="string">'YTickLabel'</span>,num2str((yt)'*1000,<span class="string">'%0.2f'</span>));
0504     <span class="keyword">else</span>
0505         set(ax,<span class="string">'YTickLabel'</span>,[]);
0506     <span class="keyword">end</span>
0507 
0508     set(ax,<span class="string">'XTickLabel'</span>,[],<span class="string">'XGrid'</span>,<span class="string">'on'</span>,<span class="string">'YGrid'</span>,<span class="string">'on'</span>);
0509         
0510     x = xlim(ax); y = ylim(ax);
0511     text(x(1),y(2),num2str(nc,<span class="string">'%d'</span>), <span class="keyword">...</span>
0512         <span class="string">'Parent'</span>,ax,<span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0513         <span class="string">'VerticalAlignment'</span>,<span class="string">'Bottom'</span>, <span class="keyword">...</span>
0514         <span class="string">'HorizontalAlignment'</span>,<span class="string">'Left'</span>);
0515     
0516     text(x(2),y(2),h.POOLIDS{up(i)+1}, <span class="keyword">...</span>
0517         <span class="string">'Parent'</span>,ax,<span class="string">'FontSize'</span>,10,<span class="string">'Color'</span>,[1 1 1],<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>, <span class="keyword">...</span>
0518         <span class="string">'BackgroundColor'</span>,colors(i,:), <span class="keyword">...</span>
0519         <span class="string">'VerticalAlignment'</span>,<span class="string">'Bottom'</span>, <span class="keyword">...</span>
0520         <span class="string">'HorizontalAlignment'</span>,<span class="string">'Right'</span>);
0521      
0522     uim = uicontextmenu;
0523     uimenu(uim,<span class="string">'Tag'</span>,<span class="string">'Select_Pool'</span>,<span class="string">'Label'</span>,<span class="string">'Select Pool'</span>, <span class="keyword">...</span>
0524         <span class="string">'UserData'</span>,up(i),<span class="string">'Callback'</span>,{@<a href="#_sub21" class="code" title="subfunction SelectPool(hObj,event) ">SelectPool</a>});
0525     set(ax,<span class="string">'UIContextMenu'</span>,uim,<span class="string">'UserData'</span>,up(i));
0526 
0527     set(ax,<span class="string">'ButtonDownFcn'</span>,{@<a href="#_sub21" class="code" title="subfunction SelectPool(hObj,event) ">SelectPool</a>});
0528     
0529 <span class="keyword">end</span>
0530 
0531 <a name="_sub13" href="#_subfunctions" class="code">function PlotPCA(h)</a>
0532 PCA    = h.PCA;
0533 C      = h.CLASSLIST;
0534 uc     = h.UCLASSES;
0535 colors = hsv(length(h.UCLASSES));
0536 
0537 <span class="keyword">if</span> isempty(PCA), <span class="keyword">return</span>; <span class="keyword">end</span>
0538 
0539 set(h.panel_pca,<span class="string">'Title'</span>,<span class="string">'Rendering...'</span>); drawnow
0540 
0541 hlclass = get(findall(h.panel_classes,<span class="string">'XColor'</span>,<span class="string">'r'</span>),<span class="string">'UserData'</span>);
0542 <span class="keyword">if</span> iscell(hlclass), hlclass = cell2mat(hlclass); <span class="keyword">end</span>
0543     
0544 ui = get(h.panel_pca,<span class="string">'UIContextMenu'</span>);
0545 is2d = strcmp(get(findobj(ui,<span class="string">'Tag'</span>,<span class="string">'PCA_2D'</span>),<span class="string">'Checked'</span>),<span class="string">'on'</span>);
0546 is2d_density = strcmp(get(findobj(ui,<span class="string">'Tag'</span>,<span class="string">'PCA_2D_DENSITY'</span>),<span class="string">'Checked'</span>),<span class="string">'on'</span>);
0547 
0548 ax = get(h.panel_pca,<span class="string">'Children'</span>);
0549 <span class="keyword">if</span> ~is2d &amp;&amp; ~isempty(ax), [az,el] = view(ax); <span class="keyword">else</span> az = 3; el = []; <span class="keyword">end</span>
0550 delete(ax);
0551 
0552 PCAx = PCA.scores(:,1); PCAy = PCA.scores(:,2); PCAz = PCA.scores(:,3);
0553 
0554 <span class="keyword">if</span> is2d
0555     set(findobj(h.figure1,<span class="string">'Tag'</span>,<span class="string">'toolbar_r3d'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0556 <span class="keyword">else</span>
0557     set(findobj(h.figure1,<span class="string">'Tag'</span>,<span class="string">'toolbar_r3d'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0558 <span class="keyword">end</span>
0559 
0560 <span class="keyword">if</span> is2d &amp;&amp; is2d_density
0561     <span class="keyword">for</span> i = 1:3
0562         subax(i) = subplot(2,2,i,<span class="string">'Parent'</span>,h.panel_pca); <span class="comment">%#ok&lt;AGROW&gt;</span>
0563         hold(subax(i),<span class="string">'on'</span>);
0564         axis square
0565     <span class="keyword">end</span>
0566     
0567     <span class="comment">% compute 2D histogram PC1 vs PC2</span>
0568     xbins = linspace(min(PCAx),max(PCAx),50);
0569     ybins = linspace(min(PCAy),max(PCAy),50);
0570     
0571     hd = zeros(length(xbins),length(ybins));
0572     <span class="keyword">for</span> i = 1:length(xbins)-1
0573         <span class="keyword">for</span> j = 1:length(ybins)-1
0574             hd(i,j) = sum(PCAx &gt;= xbins(i) &amp; PCAx &lt; xbins(i+1) <span class="keyword">...</span>
0575                 &amp; PCAy &gt;= ybins(j) &amp; PCAy &lt; ybins(j+1));
0576             
0577         <span class="keyword">end</span>
0578     <span class="keyword">end</span>
0579     imagesc(interp2(hd,2)',<span class="string">'Parent'</span>,subax(1));
0580     xlabel(subax(1),<span class="string">'PC1'</span>); ylabel(subax(1),<span class="string">'PC2'</span>);
0581     axis square
0582 
0583     <span class="comment">% compute 2D histogram PC1 vs PC3</span>
0584     xbins = linspace(min(PCAx),max(PCAx),50);
0585     ybins = linspace(min(PCAz),max(PCAz),50);
0586     
0587     hd = zeros(length(xbins),length(ybins));
0588     <span class="keyword">for</span> i = 1:length(xbins)-1
0589         <span class="keyword">for</span> j = 1:length(ybins)-1
0590             hd(i,j) = sum(PCAx &gt;= xbins(i) &amp; PCAx &lt; xbins(i+1) <span class="keyword">...</span>
0591                 &amp; PCAz &gt;= ybins(j) &amp; PCAz &lt; ybins(j+1));
0592             
0593         <span class="keyword">end</span>
0594     <span class="keyword">end</span>
0595     imagesc(interp2(hd,2)',<span class="string">'Parent'</span>,subax(2));
0596     xlabel(subax(2),<span class="string">'PC1'</span>); ylabel(subax(2),<span class="string">'PC3'</span>);
0597     axis square
0598 
0599     <span class="comment">% compute 2D histogram PC2 vs PC3</span>
0600     xbins = linspace(min(PCAy),max(PCAy),50);
0601     ybins = linspace(min(PCAz),max(PCAz),50);
0602     
0603     hd = zeros(length(xbins),length(ybins));
0604     <span class="keyword">for</span> i = 1:length(xbins)-1
0605         <span class="keyword">for</span> j = 1:length(ybins)-1
0606             hd(i,j) = sum(PCAy &gt;= xbins(i) &amp; PCAy &lt; xbins(i+1) <span class="keyword">...</span>
0607                 &amp; PCAz &gt;= ybins(j) &amp; PCAz &lt; ybins(j+1));
0608             
0609         <span class="keyword">end</span>
0610     <span class="keyword">end</span>
0611     
0612     imagesc(interp2(hd,2)',<span class="string">'Parent'</span>,subax(3));
0613     xlabel(subax(3),<span class="string">'PC2'</span>); ylabel(subax(3),<span class="string">'PC3'</span>);
0614     axis square
0615     
0616     set(subax,<span class="string">'XTick'</span>,[],<span class="string">'YTick'</span>,[],<span class="string">'ydir'</span>,<span class="string">'normal'</span>);
0617     
0618 <span class="keyword">elseif</span> is2d
0619     
0620     <span class="keyword">for</span> i = 1:3
0621         subax(i) = subplot(2,2,i,<span class="string">'Parent'</span>,h.panel_pca); <span class="comment">%#ok&lt;AGROW&gt;</span>
0622         hold(subax(i),<span class="string">'on'</span>);
0623         axis square
0624     <span class="keyword">end</span>
0625     
0626     <span class="keyword">for</span> i = 1:length(uc)
0627         <span class="keyword">if</span> isempty(hlclass)
0628             c = colors(i,:);
0629             mrk = <span class="string">'*'</span>; msz = 3;
0630         <span class="keyword">elseif</span> any(uc(i) == hlclass)
0631             c = colors(i,:);
0632             mrk = <span class="string">'*'</span>; msz = 3;
0633         <span class="keyword">else</span>
0634             c = [0.8 0.8 0.8];
0635             mrk = <span class="string">'s'</span>; msz = 1;
0636         <span class="keyword">end</span>
0637         
0638         ind = C(2,:) == uc(i);
0639         
0640         plot(PCAx(ind),PCAy(ind), <span class="keyword">...</span>
0641             mrk,<span class="string">'MarkerEdgeColor'</span>,c, <span class="keyword">...</span>
0642             <span class="string">'MarkerFaceColor'</span>,c,<span class="string">'MarkerSize'</span>,msz,<span class="string">'Parent'</span>,subax(1))
0643         
0644         plot(PCAx(ind),PCAz(ind), <span class="keyword">...</span>
0645             mrk,<span class="string">'MarkerEdgeColor'</span>,c, <span class="keyword">...</span>
0646             <span class="string">'MarkerFaceColor'</span>,c,<span class="string">'MarkerSize'</span>,msz,<span class="string">'Parent'</span>,subax(2))
0647         
0648         plot(PCAy(ind),PCAz(ind), <span class="keyword">...</span>
0649             mrk,<span class="string">'MarkerEdgeColor'</span>,c, <span class="keyword">...</span>
0650             <span class="string">'MarkerFaceColor'</span>,c,<span class="string">'MarkerSize'</span>,msz,<span class="string">'Parent'</span>,subax(3))
0651     <span class="keyword">end</span>
0652     
0653     q = quantile([PCAx PCAy PCAz],[1e-5 1-1e-5]);
0654     <span class="keyword">for</span> i = 1:3, hold(subax(i),<span class="string">'off'</span>); <span class="keyword">end</span>
0655     <span class="keyword">if</span> ~all(q)
0656         q(:,~all(q)) = [-0.1e-4 0.1e-4]; <span class="comment">% catch for 0 scales</span>
0657     <span class="keyword">end</span>
0658     xlim(subax(1),q(:,1)); ylim(subax(1),q(:,2));
0659     xlim(subax(2),q(:,1)); ylim(subax(2),q(:,3));
0660     xlim(subax(3),q(:,2)); ylim(subax(3),q(:,3));
0661     set(subax,<span class="string">'XTick'</span>,[],<span class="string">'YTick'</span>,[],<span class="string">'Box'</span>,<span class="string">'on'</span>);
0662     xlabel(subax(1),<span class="string">'PC1'</span>); xlabel(subax(2),<span class="string">'PC1'</span>); xlabel(subax(3),<span class="string">'PC2'</span>);
0663     ylabel(subax(1),<span class="string">'PC2'</span>); ylabel(subax(2),<span class="string">'PC3'</span>); ylabel(subax(3),<span class="string">'PC3'</span>);
0664 <span class="keyword">else</span>
0665     ax = axes(<span class="string">'Parent'</span>,h.panel_pca,<span class="string">'DrawMode'</span>,<span class="string">'fast'</span>);
0666     hold(ax,<span class="string">'on'</span>);
0667     <span class="keyword">for</span> i = 1:length(uc)
0668         <span class="keyword">if</span> isempty(hlclass)
0669             c = colors(i,:);
0670         <span class="keyword">elseif</span> any(uc(i) == hlclass)
0671             c = colors(i,:);
0672         <span class="keyword">else</span>
0673             c = [0.8 0.8 0.8];
0674         <span class="keyword">end</span>
0675         ind = C(2,:) == uc(i);
0676         
0677         hold(ax,<span class="string">'on'</span>);
0678         plot3(PCAx(ind),PCAy(ind),PCAz(ind), <span class="keyword">...</span>
0679             <span class="string">'s'</span>,<span class="string">'MarkerEdgeColor'</span>,c, <span class="keyword">...</span>
0680             <span class="string">'MarkerFaceColor'</span>,c,<span class="string">'MarkerSize'</span>,2,<span class="string">'Parent'</span>,ax);
0681     <span class="keyword">end</span>
0682     hold(ax,<span class="string">'off'</span>);
0683     <span class="comment">%         m = mean(PCA.scores(:,1:3));</span>
0684     q = quantile([PCAx PCAy PCAz],[.001 .999]);
0685     xlim(ax,q(:,1)); ylim(ax,q(:,2)); zlim(ax,q(:,3));
0686     view(ax,[az,el]);
0687     set(ax,<span class="string">'XTick'</span>,[],<span class="string">'YTick'</span>,[],<span class="string">'ZTick'</span>,[]);
0688     box(ax,<span class="string">'on'</span>);
0689     xlabel(ax,<span class="string">'PC1'</span>); ylabel(ax,<span class="string">'PC2'</span>); zlabel(ax,<span class="string">'PC3'</span>);
0690     
0691 <span class="keyword">end</span>
0692 
0693 lat = h.PCA.latent;
0694 expvar = sum(lat(1:3))/sum(lat) * 100;
0695 iexpvar = lat(1:3)/sum(lat) * 100;
0696 set(h.panel_pca,<span class="string">'Title'</span>,sprintf(<span class="string">'PCA (%0.1f%% of variance explained [%0.0f%% | %0.0f%% | %0.0f%%])'</span>, <span class="keyword">...</span>
0697     expvar,iexpvar));
0698 
0699 
0700 <a name="_sub14" href="#_subfunctions" class="code">function PlotTime(h)</a>
0701 C = h.CLASSLIST;
0702 uc = h.UCLASSES;
0703 colors = hsv(length(h.UCLASSES));
0704 
0705 suc = <a href="#_sub17" class="code" title="subfunction suc = GetSelectedUnitClasses(h)">GetSelectedUnitClasses</a>(h);
0706 
0707 <span class="comment">% Plot time panel</span>
0708 ax = findobj(h.figure1,<span class="string">'tag'</span>,<span class="string">'timeaxis'</span>);
0709 <span class="keyword">if</span> isempty(ax)
0710     ax = axes(<span class="string">'Parent'</span>,h.panel_time,<span class="string">'tag'</span>,<span class="string">'timeaxis'</span>);
0711 <span class="keyword">end</span>
0712 cla(ax)
0713 hold(ax,<span class="string">'on'</span>)
0714 ind = ~ismember(C(2,:),suc);
0715 <span class="keyword">if</span> ~all(ind)
0716     plot(ax,h.PCA.scores(ind,1),h.TS_UNWRAPPED(ind)/60,<span class="string">'s'</span>, <span class="keyword">...</span>
0717         <span class="string">'color'</span>,[0.8 0.8 0.8],<span class="string">'markersize'</span>,1);
0718 <span class="keyword">else</span>
0719     suc = uc;
0720 <span class="keyword">end</span>
0721 <span class="keyword">for</span> i = suc
0722     ind = C(2,:) == i;
0723     c = colors(uc==i,:);
0724     plot(ax,h.PCA.scores(ind,1),h.TS_UNWRAPPED(ind)/60,<span class="string">'*'</span>, <span class="keyword">...</span>
0725         <span class="string">'color'</span>,c,<span class="string">'markersize'</span>,4);
0726 <span class="keyword">end</span>
0727 hold(ax,<span class="string">'off'</span>)
0728 axis(ax,<span class="string">'tight'</span>);
0729 xlabel(<span class="string">'PC1'</span>); ylabel(<span class="string">'time (m)'</span>);
0730 box(ax,<span class="string">'on'</span>);
0731 
0732 <a name="_sub15" href="#_subfunctions" class="code">function PlotAnalytics(h,results)</a>
0733 <span class="comment">% following a call to to ComputeAnalytics</span>
0734 delete(get(h.panel_analytics,<span class="string">'Children'</span>));
0735 
0736 C = h.CLASSLIST;
0737 W  = h.WAVEFORMS;
0738 uc = h.UCLASSES;
0739 colors = hsv(length(h.UCLASSES));
0740 
0741 t = get(h.toolbar_bands,<span class="string">'State'</span>);
0742 <span class="keyword">if</span> strcmp(t,<span class="string">'on'</span>)
0743     opt = <span class="string">'bands'</span>;
0744 <span class="keyword">else</span>
0745     opt = <span class="string">'lines'</span>;
0746 <span class="keyword">end</span>
0747 
0748 ISI          = results.ISI;
0749 AUTOCORR     = results.AUTOCORR;
0750 TIMESEQUENCE = results.TIMESEQUENCE;
0751 
0752 <span class="keyword">for</span> i = 1:4
0753     subplot(1,4,i,<span class="string">'Parent'</span>,h.panel_analytics);
0754 <span class="keyword">end</span>
0755 
0756 <span class="keyword">if</span> isempty(TIMESEQUENCE.firingrate) || isempty(ISI.counts)
0757     <span class="keyword">return</span>
0758 <span class="keyword">end</span>
0759 
0760 ax = subplot(1,4,1);
0761 bar(ax,ISI.bins*1000,ISI.counts,<span class="string">'BarWidth'</span>,1,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0762 <span class="comment">% ylabel(ax,'counts'); xlabel(ax,'ISI (ms)');</span>
0763 xlim(ax,[0 max(ISI.bins)*1000]);
0764 set(ax,<span class="string">'XTick'</span>,[]);
0765 text(max(xlim(ax)),max(ylim(ax)), <span class="keyword">...</span>
0766     sprintf(<span class="string">'peak count = %d\npeak bin = %0.1f ms\nmedian = %0.1f\nmode = %0.1f'</span>, <span class="keyword">...</span>
0767     ISI.peak,ISI.peakbin*1000,ISI.median,ISI.mode), <span class="keyword">...</span>
0768     <span class="string">'Parent'</span>,ax,<span class="string">'FontSize'</span>,7, <span class="keyword">...</span>
0769     <span class="string">'BackgroundColor'</span>,[1 1 1], <span class="keyword">...</span>
0770     <span class="string">'VerticalAlignment'</span>,<span class="string">'Top'</span>, <span class="keyword">...</span>
0771     <span class="string">'HorizontalAlignment'</span>,<span class="string">'Right'</span>);
0772 
0773 
0774 ax = subplot(1,4,2);
0775 bar(ax,AUTOCORR.lags,AUTOCORR.corr,<span class="string">'BarWidth'</span>,1,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0776 <span class="comment">% title(ax,'correlation');</span>
0777 xlim(ax,[min(AUTOCORR.lags) max(AUTOCORR.lags)]);
0778 ylim(ax,[0 max(ylim(ax))]);
0779 set(ax,<span class="string">'XTick'</span>,[]);
0780 
0781 suc = <a href="#_sub17" class="code" title="subfunction suc = GetSelectedUnitClasses(h)">GetSelectedUnitClasses</a>(h);
0782 
0783 ax = subplot(1,4,3);
0784 cla(ax)
0785 hold(ax,<span class="string">'on'</span>)
0786 <span class="keyword">for</span> i = 1:length(suc)
0787     ind = C(2,:) == suc(i);
0788     [mW,hW] = hist(min(W(ind,:),[],2),100);
0789     barh(ax,hW,mW,<span class="string">'Barwidth'</span>,1,<span class="string">'Edgecolor'</span>,<span class="string">'none'</span>,<span class="string">'FaceColor'</span>,colors(uc==suc(i),:));
0790 <span class="keyword">end</span>
0791 axis tight
0792 box on
0793 hold(ax,<span class="string">'off'</span>)
0794 y = min(ylim);
0795 <span class="keyword">if</span> y &gt;= 0, y = -1; <span class="keyword">end</span>
0796 set(ax,<span class="string">'ylim'</span>,[y 0],<span class="string">'XTick'</span>,[]);
0797 
0798 ax = subplot(1,4,4);
0799 <span class="comment">% bar(ax,TIMESEQUENCE.bins,TIMESEQUENCE.firingrate,'BarWidth',1,'EdgeColor','none');</span>
0800 <span class="comment">% xlim(ax,[0 TIMESEQUENCE.bins(end)]);</span>
0801 <span class="comment">% set(ax,'XTick',[]);</span>
0802 <span class="comment">% ylabel(ax,'Firing Rate (Hz)');</span>
0803 <span class="comment">% maxV = max(max(abs(W)));</span>
0804 cla(ax);
0805 hold(ax,<span class="string">'on'</span>);
0806 <span class="keyword">for</span> i = 1:length(suc)
0807     ind = C(2,:) == suc(i);
0808         
0809     <span class="keyword">if</span> sum(ind) &lt;= 1
0810         op = <span class="string">'lines'</span>;
0811     <span class="keyword">else</span>
0812         op = opt;
0813     <span class="keyword">end</span>
0814     
0815 
0816     <span class="keyword">switch</span> op
0817         <span class="keyword">case</span> <span class="string">'lines'</span>
0818             <span class="comment">% if lots of spikes, then just display a random subsample</span>
0819             <span class="keyword">if</span> sum(ind) &gt; 1000, ind = find(ind); ind = ind(randperm(1000)); <span class="keyword">end</span>
0820             plot(ax,1:size(W,2),W(ind,:)',<span class="string">'Color'</span>,colors(uc==suc(i),:))
0821         <span class="keyword">case</span> <span class="string">'bands'</span>
0822             q = quantile(W(ind,:),[0.025 0.975])';
0823             y = [q(:,1); flipud(q(:,2))];
0824             x = [1:size(W,2) size(W,2):-1:1];
0825             hl = fill(x',y,colors(uc==suc(i),:),<span class="string">'Parent'</span>,ax,<span class="string">'LineStyle'</span>,<span class="string">'none'</span>);
0826             set(hl,<span class="string">'ButtonDownFcn'</span>,{@<a href="#_sub16" class="code" title="subfunction ChangePlotOrder(hObj,evnt,hl,ax) ">ChangePlotOrder</a>,hl,ax});
0827     <span class="keyword">end</span>
0828 <span class="keyword">end</span>
0829 hold(ax,<span class="string">'off'</span>);
0830 box(ax,<span class="string">'on'</span>);
0831 xlim(ax,[1 size(W,2)]);
0832 <span class="comment">% ylim(ax,[-maxV maxV]);</span>
0833 
0834 
0835 
0836 
0837 <a name="_sub16" href="#_subfunctions" class="code">function ChangePlotOrder(hObj,evnt,hl,ax) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0838 c = get(ax,<span class="string">'Children'</span>);
0839 ind = hl == c;
0840 
0841 <span class="keyword">if</span> hl == c(1)
0842     t = c(~ind);
0843     t(end+1) = hObj;
0844 <span class="keyword">else</span>
0845     t = hObj;
0846     t(end+1:length(c)) = c(~ind);
0847 <span class="keyword">end</span>
0848 
0849 set(ax,<span class="string">'Children'</span>,t);
0850 
0851 
0852 
0853 
0854 
0855 
0856 
0857 
0858 
0859 
0860 
0861 
0862 
0863 
0864 
0865 
0866 
0867 
0868 
0869 
0870 
0871 
0872 
0873 
0874 
0875 <span class="comment">%% Helpers</span>
0876 <a name="_sub17" href="#_subfunctions" class="code">function suc = GetSelectedUnitClasses(h)</a>
0877 axc = get(h.panel_classes,<span class="string">'Children'</span>);
0878 um  = cell2mat(get(axc,<span class="string">'UIContextMenu'</span>));
0879 umc = findall(um,<span class="string">'Tag'</span>,<span class="string">'Select_Class'</span>,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
0880 suc = get(umc,<span class="string">'UserData'</span>);
0881 <span class="keyword">if</span> iscell(suc), suc = cell2mat(suc); <span class="keyword">end</span>
0882 suc = suc(:)';
0883 
0884 
0885 
0886 
0887 <span class="comment">%% Analysis Functions</span>
0888 <a name="_sub18" href="#_subfunctions" class="code">function results = ComputeAnalytics(timestamps)</a>
0889 <span class="comment">% timestamps is either an N x 1 matrix for individual dataset or N x 1 cell</span>
0890 <span class="comment">% array of N x 1 matrices for multiple datasets</span>
0891 
0892 <span class="keyword">if</span> ~iscell(timestamps), timestamps = {timestamps}; <span class="keyword">end</span>
0893 
0894 timestamps = reshape(timestamps,numel(timestamps),1);
0895 ts = cell2mat(timestamps');
0896 
0897 <span class="comment">% compute ISI</span>
0898 bins = 0:0.001:0.099;
0899 d = diff(sort(ts));
0900 counts = histc(d,bins);
0901 results.ISI.counts = counts;
0902 results.ISI.bins   = bins;
0903 [p,pb] = max(counts);
0904 results.ISI.peak   = p;
0905 results.ISI.peakbin = bins(pb);
0906 results.ISI.mode   = mode(counts);
0907 results.ISI.median = median(counts);
0908 
0909 <span class="comment">% compute autocorrelation</span>
0910 binsize = 0.005;
0911 bins = 0:binsize:max(ts)-binsize;
0912 bts = histc(ts,bins);
0913 [c,lags] = xcorr(bts,100);
0914 lags = lags * binsize;
0915 x = lags == 0;
0916 results.AUTOCORR.lags = lags(~x);
0917 results.AUTOCORR.corr = c(~x);
0918 
0919 <span class="comment">% binned timestamps</span>
0920 binsize = 60;
0921 bins = 0:binsize:max(ts)-binsize;
0922 c = histc(ts,bins);
0923 results.TIMESEQUENCE.firingrate = c / binsize;
0924 results.TIMESEQUENCE.bins = bins;
0925 
0926 
0927 
0928 
0929 
0930 
0931 
0932 
0933 
0934 
0935 
0936 
0937 
0938 
0939 
0940 
0941 <span class="comment">%% Update GUI</span>
0942 
0943 <a name="_sub19" href="#_subfunctions" class="code">function UIPCA(hObj,evnt,opt) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
0944 h = guidata(hObj);
0945 
0946 p = get(hObj,<span class="string">'Parent'</span>);
0947 
0948 h2D.h = findobj(p,<span class="string">'Tag'</span>,<span class="string">'PCA_2D'</span>);
0949 h2D.density = findobj(p,<span class="string">'Tag'</span>,<span class="string">'PCA_2D_DENSITY'</span>);
0950 h3D.h = findobj(p,<span class="string">'Tag'</span>,<span class="string">'PCA_3D'</span>);
0951 
0952 n = get(hObj,<span class="string">'Tag'</span>);
0953 
0954 <span class="keyword">switch</span> n
0955     <span class="keyword">case</span> <span class="string">'PCA_2D'</span>
0956         set(h2D.density,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0957         set(h2D.h,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
0958         set(h3D.h,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0959         
0960     <span class="keyword">case</span> <span class="string">'PCA_2D_DENSITY'</span>
0961         <span class="keyword">if</span> strcmp(get(h2D.density,<span class="string">'Checked'</span>),<span class="string">'on'</span>)
0962             set(h2D.density,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0963         <span class="keyword">else</span>
0964             set(h2D.density,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
0965         <span class="keyword">end</span>
0966         
0967     <span class="keyword">case</span> <span class="string">'PCA_3D'</span>
0968         set(h2D.density,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0969         set(h2D.h,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0970         set(h3D.h,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
0971 <span class="keyword">end</span>   
0972 
0973 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'watch'</span>); drawnow
0974 <a href="#_sub13" class="code" title="subfunction PlotPCA(h)">PlotPCA</a>(h);
0975 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);
0976 
0977 <a name="_sub20" href="#_subfunctions" class="code">function SelectClass(hObj,evnt) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
0978 h = guidata(hObj);
0979 
0980 <span class="keyword">if</span> strcmp(get(h.figure1,<span class="string">'SelectionType'</span>),<span class="string">'alt'</span>) <span class="keyword">...</span>
0981         &amp;&amp; ~any(strcmp(get(gcbo,<span class="string">'Type'</span>),{<span class="string">'uimenu'</span>,<span class="string">'uipushtool'</span>}))
0982     <span class="keyword">return</span>
0983 <span class="keyword">end</span>
0984 
0985 <span class="keyword">if</span> strcmp(get(hObj,<span class="string">'Type'</span>),<span class="string">'axes'</span>)
0986     umc = get(hObj,<span class="string">'UIContextMenu'</span>);
0987     hObj = findobj(umc,<span class="string">'Tag'</span>,<span class="string">'Select_Class'</span>);
0988 <span class="keyword">end</span>
0989 
0990 ax = get(h.panel_classes,<span class="string">'Children'</span>);
0991 um = cell2mat(get(ax,<span class="string">'UIContextMenu'</span>));
0992 umc = findall(um,<span class="string">'Tag'</span>,<span class="string">'Select_Class'</span>);
0993 
0994 ht = get(hObj,<span class="string">'Tag'</span>);
0995 <span class="keyword">if</span> strcmp(ht,<span class="string">'toolbar_all_classes'</span>)
0996     set(umc,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
0997 <span class="keyword">elseif</span> strcmp(ht,<span class="string">'toolbar_no_classes'</span>)
0998     set(umc,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0999 <span class="keyword">elseif</span> ~strcmp(ht,<span class="string">'figure1'</span>)
1000     <span class="comment">% toggle current selection</span>
1001     c = get(hObj,<span class="string">'Checked'</span>);
1002     <span class="keyword">if</span> strcmp(c,<span class="string">'off'</span>)
1003         set(hObj,<span class="string">'Checked'</span>,<span class="string">'on'</span>)
1004     <span class="keyword">else</span>
1005         set(hObj,<span class="string">'Checked'</span>,<span class="string">'off'</span>)
1006     <span class="keyword">end</span>
1007 <span class="keyword">end</span>
1008 
1009 
1010 <span class="comment">% Update which classes are highlighted</span>
1011 selclass = [];
1012 <span class="keyword">for</span> i = 1:length(umc)
1013     <span class="keyword">if</span> strcmp(get(umc(i),<span class="string">'Checked'</span>),<span class="string">'on'</span>) 
1014         set(ax(i),<span class="string">'XColor'</span>,<span class="string">'r'</span>,<span class="string">'YColor'</span>,<span class="string">'r'</span>);
1015         selclass(end+1) = get(ax(i),<span class="string">'UserData'</span>); <span class="comment">%#ok&lt;AGROW&gt;</span>
1016     <span class="keyword">else</span>
1017         set(ax(i),<span class="string">'XColor'</span>,<span class="string">'k'</span>,<span class="string">'YColor'</span>,<span class="string">'k'</span>);
1018     <span class="keyword">end</span>
1019 <span class="keyword">end</span>
1020 
1021 <span class="comment">% replot based on selections</span>
1022 <a href="#_sub13" class="code" title="subfunction PlotPCA(h)">PlotPCA</a>(h);
1023 <a href="#_sub14" class="code" title="subfunction PlotTime(h)">PlotTime</a>(h);
1024 
1025 timestamps = cell(size(selclass));
1026 <span class="keyword">for</span> i = 1:length(selclass)
1027     ind = h.CLASSLIST(2,:) == selclass(i);
1028     timestamps{i} = h.TS_UNWRAPPED(ind)';
1029 <span class="keyword">end</span>
1030 results = <a href="#_sub18" class="code" title="subfunction results = ComputeAnalytics(timestamps)">ComputeAnalytics</a>(timestamps);
1031 <a href="#_sub15" class="code" title="subfunction PlotAnalytics(h,results)">PlotAnalytics</a>(h,results);
1032 
1033 <a name="_sub21" href="#_subfunctions" class="code">function SelectPool(hObj,event) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
1034 h = guidata(hObj);
1035 C = h.CLASSLIST;
1036 P = h.POOLS;
1037 
1038 <span class="keyword">if</span> strcmp(get(h.figure1,<span class="string">'SelectionType'</span>),<span class="string">'alt'</span>) <span class="keyword">...</span>
1039         &amp;&amp; ~any(strcmp(get(gcbo,<span class="string">'Type'</span>),{<span class="string">'uimenu'</span>,<span class="string">'uipushtool'</span>}))
1040     <span class="keyword">return</span>;
1041 <span class="keyword">end</span>
1042 
1043 cax = get(h.panel_classes,<span class="string">'Children'</span>);
1044 cum = cell2mat(get(cax,<span class="string">'UIContextMenu'</span>));
1045 cumc = findall(cum,<span class="string">'Tag'</span>,<span class="string">'Select_Class'</span>);
1046 
1047 pud = get(hObj,<span class="string">'UserData'</span>);
1048 cud = get(cum,<span class="string">'UserData'</span>);
1049 <span class="keyword">if</span> iscell(cud), cud = cell2mat(cud); <span class="keyword">end</span>
1050 
1051 pcind = P == pud;
1052 uc = unique(C(2,pcind));
1053 
1054 set(cumc,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1055 set(cumc(ismember(cud,uc)),<span class="string">'Checked'</span>,<span class="string">'on'</span>);
1056 
1057 <a href="#_sub20" class="code" title="subfunction SelectClass(hObj,evnt) ">SelectClass</a>(h.figure1);
1058 
1059 <a name="_sub22" href="#_subfunctions" class="code">function UpdateUnitType(hObj,evnt,ax,classid) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
1060 h = guidata(hObj);
1061 C = h.CLASSLIST;
1062 
1063 <span class="comment">% alter all selected classes</span>
1064 ax = get(h.panel_classes,<span class="string">'Children'</span>);
1065 um = cell2mat(get(ax,<span class="string">'UIContextMenu'</span>));
1066 f = findall(um,<span class="string">'Tag'</span>,<span class="string">'Select_Class'</span>,<span class="string">'-and'</span>,<span class="string">'Checked'</span>,<span class="string">'on'</span>); <span class="comment">% friends</span>
1067 <span class="keyword">if</span> isempty(f), f  = hObj; <span class="keyword">end</span>
1068 pf = get(f,<span class="string">'Parent'</span>);
1069 <span class="keyword">if</span> iscell(pf), pf = cell2mat(pf); <span class="keyword">end</span>
1070 
1071 
1072 <span class="comment">% NT = get(hObj,'Tag');</span>
1073 set(findall(pf,<span class="string">'-regexp'</span>,<span class="string">'Tag'</span>,<span class="string">'ut*'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1074 set(hObj,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
1075 
1076 CT = get(pf,<span class="string">'UserData'</span>);    <span class="comment">% class type</span>
1077 <span class="keyword">if</span> iscell(CT), CT = cell2mat(CT); <span class="keyword">end</span>
1078 UT = get(hObj,<span class="string">'UserData'</span>); <span class="comment">% unit type</span>
1079 
1080 h.POOLS(ismember(C(2,:),CT)) = UT;
1081 
1082 h.POOLS_SAVED = false;
1083 
1084 guidata(hObj,h);
1085 
1086 <a href="#_sub12" class="code" title="subfunction PlotPools(h)">PlotPools</a>(h);
1087 <a href="#_sub23" class="code" title="subfunction UpdateClassInfo(h)">UpdateClassInfo</a>(h);
1088 
1089 <a name="_sub23" href="#_subfunctions" class="code">function UpdateClassInfo(h)</a>
1090 P = h.POOLS;
1091 C = h.CLASSLIST;
1092 Pc = lines(length(h.POOLIDS));
1093 
1094 uP = unique(P);
1095 
1096 classax = get(h.panel_classes,<span class="string">'Children'</span>);
1097 <span class="keyword">for</span> i = 1:length(classax)
1098     ax = classax(i);
1099     delete(findobj(get(ax,<span class="string">'Children'</span>),<span class="string">'Type'</span>,<span class="string">'text'</span>));
1100     ud = get(ax,<span class="string">'UserData'</span>);
1101     ind = ud == C(2,:);
1102     nc = sum(ind);
1103     
1104     x = xlim(ax); y = ylim(ax);
1105     text(x(1),y(2),sprintf(<span class="string">'Class %d [%d]'</span>,ud,nc), <span class="keyword">...</span>
1106         <span class="string">'Parent'</span>,ax,<span class="string">'FontSize'</span>,8, <span class="keyword">...</span>
1107         <span class="string">'VerticalAlignment'</span>,<span class="string">'Bottom'</span>, <span class="keyword">...</span>
1108         <span class="string">'HorizontalAlignment'</span>,<span class="string">'Left'</span>);
1109     
1110     tP = P(find(ind,1));
1111     text(x(2),y(1),h.POOLIDS{tP+1}, <span class="keyword">...</span>
1112         <span class="string">'Parent'</span>,ax,<span class="string">'FontSize'</span>,9,<span class="string">'Color'</span>,[1 1 1],<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>, <span class="keyword">...</span>
1113         <span class="string">'BackgroundColor'</span>,Pc(uP==tP,:), <span class="keyword">...</span>
1114         <span class="string">'VerticalAlignment'</span>,<span class="string">'Bottom'</span>, <span class="keyword">...</span>
1115         <span class="string">'HorizontalAlignment'</span>,<span class="string">'Right'</span>);
1116     
1117     uim = get(get(ax,<span class="string">'UIContextMenu'</span>),<span class="string">'Children'</span>);
1118     set(uim,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1119     uim = findobj(uim,<span class="string">'Label'</span>,h.POOLIDS{tP+1});
1120     set(uim,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
1121     
1122 <span class="keyword">end</span>
1123 
1124 <a name="_sub24" href="#_subfunctions" class="code">function UpdateChannel(h,chandir)</a>
1125 <span class="comment">% input is channel direction as 'UP' or 'DOWN' or [] to initialize</span>
1126 
1127 <span class="keyword">if</span> ~exist(<span class="string">'chandir'</span>,<span class="string">'var'</span>) || isempty(chandir), chandir = <span class="string">''</span>; <span class="keyword">end</span>
1128 
1129 <span class="keyword">if</span> strcmp(<a href="#_sub9" class="code" title="subfunction b = EnsurePoolsSaved(h)">EnsurePoolsSaved</a>(h),<span class="string">'Cancel'</span>), <span class="keyword">return</span>; <span class="keyword">end</span>
1130 
1131 <span class="keyword">switch</span> chandir
1132     <span class="keyword">case</span> <span class="string">'UP'</span>
1133         <span class="keyword">if</span> h.DATAFILEIDX &lt; length(h.DATAFILES), h.DATAFILEIDX = h.DATAFILEIDX + 1; <span class="keyword">end</span>
1134     <span class="keyword">case</span> <span class="string">'DOWN'</span>
1135         <span class="keyword">if</span> h.DATAFILEIDX &gt; 1, h.DATAFILEIDX = h.DATAFILEIDX - 1; <span class="keyword">end</span>
1136     <span class="keyword">case</span> <span class="string">'SELECT'</span>
1137         [sel,ok] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select a Channel:'</span>, <span class="keyword">...</span>
1138             <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>, <span class="string">'Name'</span>,<span class="string">'Channels'</span>, <span class="keyword">...</span>
1139             <span class="string">'ListString'</span>,cellstr(num2str(h.CHANNELS(:))), <span class="keyword">...</span>
1140             <span class="string">'InitialValue'</span>,h.DATAFILEIDX);
1141         <span class="keyword">if</span> ~ok
1142             <span class="keyword">return</span>
1143         <span class="keyword">else</span>
1144             h.DATAFILEIDX = sel;
1145         <span class="keyword">end</span>
1146 <span class="keyword">end</span>
1147 
1148 set(findobj(h.figure1,<span class="string">'-regexp'</span>,<span class="string">'Tag'</span>,<span class="string">'toolbar_channel*'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1149 <span class="keyword">if</span> h.DATAFILEIDX == length(h.DATAFILES)
1150     set(findobj(h.figure1,<span class="string">'Tag'</span>,<span class="string">'toolbar_channel_up'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1151 <span class="keyword">end</span>
1152 <span class="keyword">if</span> h.DATAFILEIDX == 1
1153     set(findobj(h.figure1,<span class="string">'Tag'</span>,<span class="string">'toolbar_channel_down'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1154 <span class="keyword">end</span>
1155 
1156 <span class="keyword">if</span> ~isempty(chandir)
1157     <a href="#_sub4" class="code" title="subfunction OpenDataset(DATAFILEIDX)">OpenDataset</a>(h.DATAFILEIDX);
1158 <span class="keyword">end</span>
1159 
1160 <a name="_sub25" href="#_subfunctions" class="code">function UpdatePlotStyle(h) </a><span class="comment">%#ok&lt;DEFNU&gt;</span>
1161 <span class="keyword">if</span> ~isfield(h,<span class="string">'WAVEFORMS'</span>) || isempty(h.WAVEFORMS), <span class="keyword">return</span>; <span class="keyword">end</span>
1162 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'watch'</span>); drawnow
1163 <a href="#_sub10" class="code" title="subfunction PlotClasses(h)">PlotClasses</a>(h);
1164 <a href="#_sub12" class="code" title="subfunction PlotPools(h)">PlotPools</a>(h);
1165 set(h.figure1,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);</pre></div>
<hr><address>Generated on Wed 24-Jul-2013 19:48:12 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>