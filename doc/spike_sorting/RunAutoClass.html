<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of RunAutoClass</title>
  <meta name="keywords" content="RunAutoClass">
  <meta name="description" content="RunAutoClass">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">spike_sorting</a> &gt; RunAutoClass.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for spike_sorting&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>RunAutoClass
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>RunAutoClass</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function TANKS = RunAutoClass(TANKS) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> RunAutoClass
 RunAutoClass(TANKS)
 TANKS = RunAutoClass(TANKS)

 Preliminary structure to new spike classification scheme

 1) Online detected spikes(or offline using ss_detect)
 2) Align spikes by maximum negative peak (ss_align)
 3) Run principal component analysis on aligned waveforms
 4) Run AutoClass on aligned waveforms (AutoClass2)
 5) Save data for Pooling

 Pooling GUI specs:
 1) Plot waveforms of AutoClass classes
   1.1) Optionally plot color coded raw waveforms of selected classes
   1.2) Optionally plot color coded mean +/- std waveforms as bands
 2) View PCA results as projections of 1 vs 2, 1 vs 3, 2 vs 3 dimensions
   2.1) Optional 2D and 3D scatter plots of PCA scores
   2.2) Optional plot as density map (2D only)
 3) ISI for selected classes
 4) Cross/autocorrelation of selected classes
 5) Fit gaussian to negative peak amplitude from detection threshold in
 order to estimate number of undetected spikes of the selected class


 DJS 2013

 See also, <a href="RunAutoClassReport.html" class="code" title="function RunAutoClassReport(TANKS)">RunAutoClassReport</a>, <a href="Pooling_GUI2.html" class="code" title="function varargout = Pooling_GUI2(varargin)">Pooling_GUI2</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AutoClass2.html" class="code" title="function cfg = AutoClass2(W,cfg)">AutoClass2</a>	cfg = AutoClass2(W,cfg)</li><li><a href="ss_align.html" class="code" title="function spikes = ss_align( spikes )">ss_align</a>	UltraMegaSort2000 by Hill DN, Mehta SB, & Kleinfeld D  - 07/12/2010</li><li><a href="ss_default_params.html" class="code" title="function spikes = ss_default_params(Fs, varargin )">ss_default_params</a>	UltraMegaSort2000 by Hill DN, Mehta SB, & Kleinfeld D  - 07/12/2010</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function TANKS = RunAutoClass(TANKS)</a>
0002 <span class="comment">% RunAutoClass</span>
0003 <span class="comment">% RunAutoClass(TANKS)</span>
0004 <span class="comment">% TANKS = RunAutoClass(TANKS)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Preliminary structure to new spike classification scheme</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% 1) Online detected spikes(or offline using ss_detect)</span>
0009 <span class="comment">% 2) Align spikes by maximum negative peak (ss_align)</span>
0010 <span class="comment">% 3) Run principal component analysis on aligned waveforms</span>
0011 <span class="comment">% 4) Run AutoClass on aligned waveforms (AutoClass2)</span>
0012 <span class="comment">% 5) Save data for Pooling</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% Pooling GUI specs:</span>
0015 <span class="comment">% 1) Plot waveforms of AutoClass classes</span>
0016 <span class="comment">%   1.1) Optionally plot color coded raw waveforms of selected classes</span>
0017 <span class="comment">%   1.2) Optionally plot color coded mean +/- std waveforms as bands</span>
0018 <span class="comment">% 2) View PCA results as projections of 1 vs 2, 1 vs 3, 2 vs 3 dimensions</span>
0019 <span class="comment">%   2.1) Optional 2D and 3D scatter plots of PCA scores</span>
0020 <span class="comment">%   2.2) Optional plot as density map (2D only)</span>
0021 <span class="comment">% 3) ISI for selected classes</span>
0022 <span class="comment">% 4) Cross/autocorrelation of selected classes</span>
0023 <span class="comment">% 5) Fit gaussian to negative peak amplitude from detection threshold in</span>
0024 <span class="comment">% order to estimate number of undetected spikes of the selected class</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% DJS 2013</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% See also, RunAutoClassReport, Pooling_GUI2</span>
0030 
0031 
0032 
0033 <span class="keyword">if</span> nargin == 0 || isempty(TANKS)
0034     [TANKS,OK] = TDT_TankSelect(<span class="string">'SelectionMode'</span>,<span class="string">'multiple'</span>);
0035 <span class="keyword">end</span>
0036 
0037 <span class="keyword">if</span> ~OK, <span class="keyword">return</span>; <span class="keyword">end</span>
0038 
0039 cfg = [];
0040 cfg.blocks  = <span class="string">'all'</span>;
0041 cfg.datatype = <span class="string">'Spikes'</span>;
0042 <span class="comment">% cfg.datatype = 'Stream';</span>
0043 
0044 
0045 <span class="comment">% Maximum number of AutoClass threads to launch at once.  Usually set to</span>
0046 <span class="comment">% number of processors - 1</span>
0047 NThreads = 3; 
0048 
0049 <span class="keyword">for</span> tind = 1:length(TANKS)
0050     [~,TANKS{tind},~] = fileparts(TANKS{tind});
0051     cfg.tank = TANKS{tind};
0052     [data,scfg] = getTankData(cfg);
0053     
0054     Fs = scfg.fsample;
0055     
0056     <span class="keyword">if</span> isfield(data,<span class="string">'waves'</span>)
0057         <span class="comment">% filter for spikes</span>
0058         fprintf(<span class="string">'filtering for spikes ... '</span>)
0059         h = fdesign.bandpass(<span class="string">'Fst1,Fp1,Fp2,Fst2,Ast1,Ap,Ast2'</span>, <span class="keyword">...</span>
0060             300,500,5000,10000,18,0.1,18,Fs);
0061         d1 = design(h,<span class="string">'butter'</span>);
0062         sig = filtfilt(d1.sosMatrix,d1.ScaleValues,double(data.waves));
0063         
0064         <span class="comment">% compute common average reference (Ludwig et al, 2009)</span>
0065         sig = sig - repmat(mean(sig,2),1,size(sig,2));
0066         
0067         fprintf(<span class="string">'done\n'</span>)
0068         
0069         <span class="comment">% Spikes detected offline</span>
0070         fprintf(<span class="string">'detecting spikes ... '</span>)
0071         spikes = DetectSpikesQ(sig,Fs);
0072         fprintf(<span class="string">'done\n'</span>)
0073     <span class="keyword">else</span>
0074         spikes = data; clear data
0075     <span class="keyword">end</span>
0076     
0077     <span class="keyword">for</span> i = 1:length(spikes) <span class="comment">% run AutoClass one channel at a time</span>
0078         fprintf(<span class="string">'Running Channel %d (%d of %d)\n'</span>,spikes(i).channel,i,length(spikes))
0079         
0080         cfg.Spikes = spikes(i);
0081         cfg.TankCFG  = scfg;
0082         cfg.AutoClass.resultsdir = [<span class="string">'C:\AutoClass_Files\AC2_RESULTS\'</span> cfg.tank <span class="string">'\'</span>];
0083         cfg.AutoClass.fileroot   = sprintf(<span class="string">'%s_%03.0f'</span>,cfg.tank,spikes(i).channel);
0084         cfg.PCA.filename = fullfile(cfg.AutoClass.resultsdir,[cfg.AutoClass.fileroot <span class="string">'_PCA.mat'</span>]);
0085         
0086         <span class="keyword">if</span> ~isdir(cfg.AutoClass.resultsdir), mkdir(cfg.AutoClass.resultsdir); <span class="keyword">end</span>
0087         
0088         k = [];
0089         <span class="keyword">for</span> j = 1:length(spikes(i).waveforms)
0090             <span class="keyword">if</span> isempty(spikes(i).waveforms{j})
0091                 k(end+1) = j;  <span class="comment">%#ok&lt;AGROW&gt;</span>
0092             <span class="keyword">end</span>
0093         <span class="keyword">end</span>
0094         spikes(i).waveforms(k)  = [];
0095         spikes(i).timestamps(k) = [];
0096         
0097         W = cell2mat(spikes(i).waveforms');
0098         T = cell2mat(spikes(i).timestamps')';
0099         
0100         <span class="keyword">if</span> isempty(W),<span class="keyword">continue</span>; <span class="keyword">end</span>
0101         
0102         <span class="comment">% set defaults for alignment function</span>
0103         s = <a href="ss_default_params.html" class="code" title="function spikes = ss_default_params(Fs, varargin )">ss_default_params</a>(Fs);
0104         s.waveforms = W;
0105         
0106         <span class="comment">% Align Spikes by negative peak</span>
0107         s.info = [];
0108         s.spiketimes = T;
0109         s.params.max_jitter = 0.3;
0110         s.info.detect.align_sample = 9;
0111         s.info.detect.event_channel = ones(size(W,1),1);
0112         s = <a href="ss_align.html" class="code" title="function spikes = ss_align( spikes )">ss_align</a>(s);
0113         W = s.waveforms;    
0114                 
0115         <span class="comment">% Run PCA on aligned spikes</span>
0116         fprintf(<span class="string">'\t&gt; Running PCA on aligned waveforms\n'</span>)
0117         [coeffs,scores,latent] = princomp(W); <span class="comment">%#ok&lt;NASGU,ASGLU&gt;</span>
0118         
0119         fprintf(<span class="string">'\t&gt; Saving PCA results\n'</span>)
0120         save(cfg.PCA.filename,<span class="string">'coeffs'</span>,<span class="string">'scores'</span>,<span class="string">'latent'</span>);
0121         
0122         
0123         cfg.AutoClass.wrappedtimestamps = s.spiketimes;
0124         
0125         clear s
0126         
0127         <span class="comment">% Append some info to cfg structure</span>
0128         cfg.spiketotal = size(W,1);
0129         
0130         
0131         <span class="comment">% wait for processors to open up</span>
0132         <span class="keyword">while</span> 1
0133             [~,b] = dos(<span class="string">'tasklist /fi &quot;IMAGENAME eq Autoclass.exe&quot;'</span>);
0134             numthreads = length(strfind(b,<span class="string">'Autoclass'</span>));
0135             <span class="keyword">if</span> numthreads &lt; NThreads, <span class="keyword">break</span>; <span class="keyword">end</span>
0136             pause(1)
0137         <span class="keyword">end</span>
0138         
0139         
0140         <span class="comment">% Run AutoClass on aligned spikes</span>
0141         <span class="comment">%     cfg.AutoClass.variance_factor (default = 2)</span>
0142         cfg = <a href="AutoClass2.html" class="code" title="function cfg = AutoClass2(W,cfg)">AutoClass2</a>(W,cfg);
0143         
0144     <span class="keyword">end</span>
0145 <span class="keyword">end</span>
0146 
0147 fprintf(<span class="string">'Finished classifying: %s\n\n'</span>,datestr(now));
0148 
0149 
0150</pre></div>
<hr><address>Generated on Thu 11-Jul-2013 10:16:49 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>