<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of CalibrationUtil</title>
  <meta name="keywords" content="CalibrationUtil">
  <meta name="description" content="varargout = CalibrationUtil(varargin)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">GUIs</a> &gt; <a href="index.html">CalibrationUtil</a> &gt; CalibrationUtil.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for GUIs\CalibrationUtil&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>CalibrationUtil
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>varargout = CalibrationUtil(varargin)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function varargout = CalibrationUtil(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> varargout = CalibrationUtil(varargin)

 DJS 2013</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function CalibrationUtil_OpeningFcn(hObj, ~, h, varargin)</a></li><li><a href="#_sub2" class="code">function varargout = CalibrationUtil_OutputFcn(hObj, ~, h)</a></li><li><a href="#_sub3" class="code">function CheckNumeric(hObj)</a></li><li><a href="#_sub4" class="code">function stim_type_Callback(hObj, ~, h)</a></li><li><a href="#_sub5" class="code">function cfg = GatherCFG(h)</a></li><li><a href="#_sub6" class="code">function run_calibration_Callback(hObj, ~, h)</a></li><li><a href="#_sub7" class="code">function fbuffer = FilterBuffer(buffer,Fs)</a></li><li><a href="#_sub8" class="code">function res = SignalAnalysis(buffer,ref,V)</a></li><li><a href="#_sub9" class="code">function PlotSignal(buffer,Fs,h,freq)</a></li><li><a href="#_sub10" class="code">function buffer = GetBuffer(AcqRP,Fs,bdur)</a></li><li><a href="#_sub11" class="code">function ref_piston_phone_Callback(hObj, ~, h)</a></li><li><a href="#_sub12" class="code">function [hdr,data] = CalibrateNoise(cfg,h)</a></li><li><a href="#_sub13" class="code">function [hdr,data] = CalibrateTones(cfg,h)</a></li><li><a href="#_sub14" class="code">function [StimRP,AcqRP,Fs] = OpenConnection(cfg)</a></li><li><a href="#_sub15" class="code">function CloseConnection(StimRP,AcqRP)</a></li><li><a href="#_sub16" class="code">function SaveCalibration(hdr,data)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = CalibrationUtil(varargin)</a>
0002 <span class="comment">% varargout = CalibrationUtil(varargin)</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% DJS 2013</span>
0005 
0006 <span class="comment">% Edit the above text to modify the response to help CalibrationUtil</span>
0007 
0008 <span class="comment">% Last Modified by GUIDE v2.5 18-Sep-2011 15:44:13</span>
0009 
0010 <span class="comment">% Begin initialization code - DO NOT EDIT</span>
0011 gui_Singleton = 1;
0012 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0013                    <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0014                    <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub1" class="code" title="subfunction CalibrationUtil_OpeningFcn(hObj, ~, h, varargin)">CalibrationUtil_OpeningFcn</a>, <span class="keyword">...</span>
0015                    <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub2" class="code" title="subfunction varargout = CalibrationUtil_OutputFcn(hObj, ~, h)  ">CalibrationUtil_OutputFcn</a>, <span class="keyword">...</span>
0016                    <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0017                    <span class="string">'gui_Callback'</span>,   []);
0018 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0019     gui_State.gui_Callback = str2func(varargin{1});
0020 <span class="keyword">end</span>
0021 
0022 <span class="keyword">if</span> nargout
0023     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0024 <span class="keyword">else</span>
0025     gui_mainfcn(gui_State, varargin{:});
0026 <span class="keyword">end</span>
0027 <span class="comment">% End initialization code - DO NOT EDIT</span>
0028 
0029 
0030 <span class="comment">% --- Executes just before CalibrationUtil is made visible.</span>
0031 <a name="_sub1" href="#_subfunctions" class="code">function CalibrationUtil_OpeningFcn(hObj, ~, h, varargin)</a>
0032 <span class="comment">% Choose default command line output for CalibrationUtil</span>
0033 h.output = hObj;
0034 
0035 <span class="comment">% Update h structure</span>
0036 guidata(hObj, h);
0037 
0038 <span class="comment">% UIWAIT makes CalibrationUtil wait for user response (see UIRESUME)</span>
0039 <span class="comment">% uiwait(h.CalibrationUtil);</span>
0040 
0041 
0042 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0043 <a name="_sub2" href="#_subfunctions" class="code">function varargout = CalibrationUtil_OutputFcn(hObj, ~, h)  </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0044 <span class="comment">% Get default command line output from h structure</span>
0045 varargout{1} = h.output;
0046 
0047 
0048 
0049 
0050 
0051 
0052 
0053 
0054 
0055 
0056 
0057 
0058 
0059 
0060 
0061 
0062 
0063 
0064 
0065 
0066 
0067 
0068 
0069 
0070 <a name="_sub3" href="#_subfunctions" class="code">function CheckNumeric(hObj)  </a><span class="comment">%#ok&lt;DEFNU&gt;</span>
0071 v = str2num(get(hObj,<span class="string">'String'</span>)); <span class="comment">%#ok&lt;ST2NM&gt;</span>
0072 <span class="keyword">if</span> ~isscalar(v)
0073     warndlg(<span class="string">'Scalar values only'</span>,<span class="string">'Invalid entry'</span>);
0074     set(hObj,<span class="string">'String'</span>,v(1));
0075 <span class="keyword">end</span>
0076 
0077 
0078 
0079 
0080 
0081 
0082 
0083 
0084 
0085 
0086 
0087 
0088 
0089 
0090 
0091 
0092 
0093 
0094 
0095 
0096 
0097 
0098 
0099 
0100 
0101 
0102 
0103 
0104 
0105 
0106 
0107 
0108 
0109 
0110 
0111 <span class="comment">% Setup --------------------------</span>
0112 <a name="_sub4" href="#_subfunctions" class="code">function stim_type_Callback(hObj, ~, h) </a><span class="comment">%#ok&lt;DEFNU&gt;</span>
0113 ST = get(hObj,<span class="string">'String'</span>);
0114 v = ST{get(hObj,<span class="string">'Value'</span>)};
0115 
0116 <span class="keyword">switch</span> v
0117     <span class="keyword">case</span> <span class="string">'Tone'</span>
0118         <span class="comment">% prompt properties</span>
0119         prompt = {<span class="string">'Frequencies (Hz):'</span>};
0120         name   = <span class="string">'Tone Calibration'</span>;
0121         dflt   = {<span class="string">'1000:100:42000'</span>};
0122         
0123     <span class="keyword">case</span> <span class="string">'Noise'</span>
0124         prompt = {<span class="string">'Highpass (Hz)'</span>,<span class="string">'Lowpass (Hz)'</span>};
0125         name   = <span class="string">'Noise'</span>;
0126         dflt   = {<span class="string">'7127.2,10090,14254,20158,28509'</span>; <span class="keyword">...</span>
0127                   <span class="string">'8979.7,12700,17959,25398,35919'</span>};
0128         
0129     <span class="keyword">case</span> <span class="string">'Click'</span>
0130         
0131 <span class="keyword">end</span>
0132 
0133 opts.Resize = <span class="string">'on'</span>;
0134 opts.WindowStyle = <span class="string">'modal'</span>;
0135 opts.Interpreter = <span class="string">'none'</span>;
0136 res = inputdlg(prompt,name,1,dflt,opts);
0137 
0138 
0139 <span class="keyword">if</span> isempty(res)
0140     i = find(ismember(ST,h.cfg.stimtype));
0141     set(hObj,<span class="string">'Value'</span>,i);
0142     <span class="keyword">return</span>
0143 <span class="keyword">end</span>
0144 
0145 
0146 <span class="keyword">switch</span> v
0147     <span class="keyword">case</span> <span class="string">'Tone'</span>
0148         cfg.stimtype = <span class="string">'Tone'</span>;
0149         cfg.freqs    = str2num(char(res)); <span class="comment">%#ok&lt;ST2NM&gt;</span>
0150         
0151         <span class="comment">% data table properties</span>
0152         colname  = {<span class="string">'Freq'</span>,<span class="string">'Level (1V)'</span>,<span class="string">'AdjV'</span>};
0153         colform  = {<span class="string">'numeric'</span>,<span class="string">'numeric'</span>,<span class="string">'numeric'</span>};
0154         dfltdata = num2cell([cfg.freqs(:) nan(length(cfg.freqs),2)]);
0155         
0156 
0157     <span class="keyword">case</span> <span class="string">'Noise'</span>
0158         cfg.stimtype = <span class="string">'Noise'</span>;
0159         cfg.hp = str2num(res{1}); <span class="comment">%#ok&lt;ST2NM&gt;</span>
0160         cfg.lp = str2num(res{2}); <span class="comment">%#ok&lt;ST2NM&gt;</span>
0161         
0162         <span class="comment">% data table properties</span>
0163         colname = {<span class="string">'HP'</span>,<span class="string">'LP'</span>,<span class="string">'Level (1V)'</span>,<span class="string">'AdjV'</span>};
0164         colform = {<span class="string">'numeric'</span>,<span class="string">'numeric'</span>,<span class="string">'numeric'</span>,<span class="string">'numeric'</span>};
0165         dfltdata = num2cell([cfg.hp(:) cfg.lp(:) nan(length(cfg.hp),2)]);
0166         
0167     <span class="keyword">case</span> <span class="string">'Click'</span>
0168         
0169 <span class="keyword">end</span>
0170 
0171 set(h.data_table,<span class="string">'ColumnName'</span>,colname,<span class="string">'ColumnFormat'</span>,colform,<span class="string">'Data'</span>,dfltdata);
0172 
0173 h.cfg = cfg;
0174 guidata(h.CalibrationUtil,h);
0175 
0176 set(h.run_calibration,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0177 
0178 <a name="_sub5" href="#_subfunctions" class="code">function cfg = GatherCFG(h)</a>
0179 <span class="comment">% Gather configuration from GUI</span>
0180 
0181 <span class="keyword">if</span> isfield(h,<span class="string">'cfg'</span>), cfg = h.cfg; <span class="keyword">end</span>
0182 
0183 v = get(h.connection_type,<span class="string">'String'</span>);
0184 cfg.contype = v{get(h.connection_type,<span class="string">'Value'</span>)};
0185 
0186 v = get(h.stim_module,<span class="string">'String'</span>);
0187 stim.mod   = v{get(h.stim_module,<span class="string">'Value'</span>)};
0188 stim.modid = get(h.stim_module_id,<span class="string">'Value'</span>);
0189 stim.fsid  = get(h.stim_module_fs,<span class="string">'Value'</span>)+1;
0190 
0191 v = get(h.acq_module,<span class="string">'String'</span>);
0192 acq.mod   = v{get(h.acq_module,<span class="string">'Value'</span>)};
0193 acq.modid = get(h.acq_module_id,<span class="string">'Value'</span>);
0194 acq.fsid  = 5;
0195 
0196 <span class="comment">% check for single module mode</span>
0197 cfg.single_mod = strcmp(stim.mod,acq.mod) &amp; stim.modid == acq.modid;
0198 <span class="keyword">if</span> cfg.single_mod
0199     stim.rpfile = <span class="string">'STACQ_Tone_Calibration.rcx'</span>;
0200     fprintf(<span class="string">'Using single module mode\n'</span>)
0201 <span class="keyword">else</span>
0202     stim.rpfile = <span class="string">'STIM_Tone_Calibration.rcx'</span>;
0203     acq.rpfile  = <span class="string">'ACQ_Calibration.rcx'</span>;
0204 <span class="keyword">end</span>
0205 
0206 stim.rpfile = which(stim.rpfile);
0207 cfg.stim = stim;
0208 
0209 <span class="keyword">if</span> isfield(acq,<span class="string">'rpfile'</span>)
0210     acq.rpfile  = which(acq.rpfile);
0211 <span class="keyword">end</span>
0212 cfg.acq  = acq;
0213 
0214 <span class="comment">% reference info for header</span>
0215 cfg.ref.rms   = str2num(get(h.ref_rms,<span class="string">'String'</span>))/1000; <span class="comment">%#ok&lt;ST2NM&gt;</span>
0216 cfg.ref.level = str2num(get(h.ref_dB,<span class="string">'String'</span>)); <span class="comment">%#ok&lt;ST2NM&gt;</span>
0217 cfg.ref.norm  = str2num(get(h.norm_level,<span class="string">'String'</span>)); <span class="comment">%#ok&lt;ST2NM&gt;</span>
0218 
0219 <a name="_sub6" href="#_subfunctions" class="code">function run_calibration_Callback(hObj, ~, h) </a><span class="comment">%#ok&lt;DEFNU&gt;</span>
0220 <span class="keyword">if</span> ~isdir(<span class="string">'CalUtil_RPvds'</span>)
0221     errordlg(<span class="string">'RPvds calibration files directory could not be found on MATLAB search path'</span>, <span class="keyword">...</span>
0222         <span class="string">'Calibration'</span>);
0223 <span class="keyword">end</span>
0224 
0225 <span class="keyword">global</span> StimRP AcqRP
0226 
0227 <span class="keyword">switch</span> get(hObj,<span class="string">'String'</span>)
0228     <span class="keyword">case</span> <span class="string">'Halt'</span>
0229         <a href="#_sub15" class="code" title="subfunction CloseConnection(StimRP,AcqRP)">CloseConnection</a>(StimRP,AcqRP);
0230         disp(<span class="string">'Calibration interrupted by user'</span>)
0231         set(hObj,<span class="string">'String'</span>,<span class="string">'Run'</span>);
0232         
0233     <span class="keyword">case</span> <span class="string">'Run'</span>
0234         cfg = <a href="#_sub5" class="code" title="subfunction cfg = GatherCFG(h)">GatherCFG</a>(h);
0235         
0236         ST = get(h.stim_type,<span class="string">'String'</span>);
0237         ST = ST{get(h.stim_type,<span class="string">'Value'</span>)};
0238         
0239         <span class="keyword">switch</span> ST
0240             <span class="keyword">case</span> <span class="string">'Tone'</span>
0241                 <span class="keyword">if</span> cfg.single_mod
0242                     cfg.stim.rpfile = <span class="string">'STACQ_Tone_Calibration'</span>;
0243                     cfg.acq.rpfile  = <span class="string">'STACQ_Tone_Calibration'</span>;
0244                 <span class="keyword">else</span>
0245                     cfg.stim.rpfile = <span class="string">'STIM_Tone_Calibration'</span>;
0246                     cfg.acq.rpfile  = <span class="string">'ACQ_Calibration'</span>;
0247                 <span class="keyword">end</span>
0248                 calfunc = @<a href="#_sub13" class="code" title="subfunction [hdr,data] = CalibrateTones(cfg,h)">CalibrateTones</a>;
0249                 
0250                 
0251             <span class="keyword">case</span> <span class="string">'Noise'</span>
0252                 <span class="keyword">if</span> cfg.single_mod
0253                     cfg.stim.rpfile = <span class="string">'STACQ_FiltNoise_Calibration'</span>;
0254                     cfg.acq.rpfile  = <span class="string">'STACQ_FiltNoise_Calibration'</span>;
0255                 <span class="keyword">else</span>
0256                     cfg.stim.rpfile = <span class="string">'STIM_FiltNoise_Calibration'</span>;
0257                     cfg.acq.rpfile  = <span class="string">'ACQ_Calibration'</span>;
0258                 <span class="keyword">end</span>
0259                 calfunc = @<a href="#_sub12" class="code" title="subfunction [hdr,data] = CalibrateNoise(cfg,h)">CalibrateNoise</a>;
0260                 
0261             <span class="keyword">case</span> <span class="string">'Click'</span>
0262                 disp(<span class="string">'Click calibration not yet implemented'</span>)
0263                 <span class="keyword">return</span>
0264         <span class="keyword">end</span>
0265         
0266         <span class="keyword">if</span> cfg.single_mod &amp;&amp; isequal(cfg.stim.mod,<span class="string">'RX6'</span>)
0267             cfg.stim.rpfile = [cfg.stim.rpfile <span class="string">'_RX6'</span>];   
0268         <span class="keyword">end</span>
0269         <span class="keyword">if</span> cfg.single_mod &amp;&amp; isequal(cfg.acq.mod,<span class="string">'RX6'</span>)
0270             cfg.acq.rpfile = [cfg.acq.rpfile <span class="string">'_RX6'</span>];   
0271         <span class="keyword">end</span>
0272         
0273         <span class="keyword">if</span> cfg.single_mod &amp;&amp; isequal(cfg.stim.mod,<span class="string">'RZ6'</span>)
0274             cfg.stim.rpfile = [cfg.stim.rpfile <span class="string">'_RZ6'</span>];   
0275         <span class="keyword">end</span>
0276         <span class="keyword">if</span> cfg.single_mod &amp;&amp; isequal(cfg.acq.mod,<span class="string">'RZ6'</span>)
0277             cfg.acq.rpfile = [cfg.acq.rpfile <span class="string">'_RZ6'</span>];   
0278         <span class="keyword">end</span>
0279         
0280         cfg.stim.rpfile = [cfg.stim.rpfile <span class="string">'.rcx'</span>];
0281         cfg.acq.rpfile  = [cfg.acq.rpfile  <span class="string">'.rcx'</span>];
0282         
0283         cfg.stim.rpfile = which(cfg.stim.rpfile);
0284         <span class="keyword">if</span> isempty(cfg.stim.rpfile)
0285             error(<span class="string">'The RPvds file: ''%s'' was not found along the Matlab path'</span>,cfg.stim.rpfile);
0286         <span class="keyword">end</span>
0287         
0288         cfg.acq.rpfile  = which(cfg.acq.rpfile);
0289         <span class="keyword">if</span> isempty(cfg.acq.rpfile)
0290             error(<span class="string">'The RPvds file: ''%s'' was not found along the Matlab path'</span>,cfg.stim.rpfile);
0291         <span class="keyword">end</span>
0292         
0293         <span class="keyword">try</span>
0294             set(hObj,<span class="string">'String'</span>,<span class="string">'Halt'</span>)
0295             [hdr,data] = feval(calfunc,cfg,h);
0296             hdr.calfunc = calfunc;
0297             <a href="#_sub15" class="code" title="subfunction CloseConnection(StimRP,AcqRP)">CloseConnection</a>(StimRP,AcqRP);
0298             <a href="#_sub16" class="code" title="subfunction SaveCalibration(hdr,data)">SaveCalibration</a>(hdr,data);
0299             set(hObj,<span class="string">'String'</span>,<span class="string">'Run'</span>);
0300         <span class="keyword">catch</span>
0301             <a href="#_sub15" class="code" title="subfunction CloseConnection(StimRP,AcqRP)">CloseConnection</a>(StimRP,AcqRP);
0302             error(<span class="string">'There was an error running calibration'</span>)
0303             rethrow(lasterror);
0304             set(hObj,<span class="string">'String'</span>,<span class="string">'Run'</span>)
0305         <span class="keyword">end</span>
0306         
0307         
0308 <span class="keyword">end</span>
0309 
0310 
0311 
0312 
0313 <span class="comment">% Plotting/Analysis functions ---------------------------</span>
0314 <a name="_sub7" href="#_subfunctions" class="code">function fbuffer = FilterBuffer(buffer,Fs)</a>
0315 <span class="keyword">persistent</span> pHd pFs
0316 
0317 <span class="keyword">if</span> isempty(pHd) || pFs ~= Fs
0318     <span class="comment">% Filter out DC component</span>
0319     Fstop = 100;         <span class="comment">% Stopband Frequency</span>
0320     Fpass = 200;         <span class="comment">% Passband Frequency</span>
0321     Astop = 60;          <span class="comment">% Stopband Attenuation (dB)</span>
0322     Apass = 1;           <span class="comment">% Passband Ripple (dB)</span>
0323     match = <span class="string">'passband'</span>;  <span class="comment">% Band to match exactly</span>
0324     
0325     <span class="comment">% Construct an FDESIGN object and call its BUTTER method.</span>
0326     hd  = fdesign.highpass(Fstop, Fpass, Astop, Apass, Fs);
0327     pHd = design(hd, <span class="string">'butter'</span>, <span class="string">'MatchExactly'</span>, match);
0328     pFs = Fs;
0329 <span class="keyword">end</span>
0330 fbuffer = filter(pHd,buffer);
0331 
0332 <a name="_sub8" href="#_subfunctions" class="code">function res = SignalAnalysis(buffer,ref,V)</a>
0333 res.rms   = sqrt(mean(buffer.^2)); <span class="comment">% signal RMS</span>
0334 res.level = 20 * log10(res.rms/ref.rms) + ref.level; <span class="comment">% calibrated level</span>
0335 res.adjV  = V * 10 ^ ((ref.norm - res.level) / 20); <span class="comment">% adjusted voltage</span>
0336 
0337 <a name="_sub9" href="#_subfunctions" class="code">function PlotSignal(buffer,Fs,h,freq)</a>
0338 L = length(buffer);
0339 
0340 <span class="comment">% Plot Time Domain</span>
0341 tax = h.time_domain;
0342 tvec = linspace(0,L/Fs,L)*1000;
0343 plot(tax,tvec,buffer,<span class="string">'-'</span>);
0344 mav = max(abs(buffer))*1.1;
0345 set(tax,<span class="string">'ylim'</span>,[-mav mav],<span class="string">'xlim'</span>,[0 20/max(freq)]*1000); grid(tax,<span class="string">'on'</span>);
0346 xlabel(tax,<span class="string">'time (ms'</span>); ylabel(tax,<span class="string">'V'</span>); title(tax,<span class="string">'Signal'</span>);
0347 
0348 <span class="comment">% Plot Frequency Domain</span>
0349 fax = h.freq_domain;
0350 y = hann(L) .* buffer(:); <span class="comment">% apply window function (blackmanharris may be better)</span>
0351 NFFT = 2^nextpow2(L); <span class="comment">% Next power of 2 from length of y</span>
0352 Y = fft(y,NFFT)/L;
0353 f = Fs/2*linspace(0,1,NFFT/2+1);
0354 <span class="keyword">for</span> i = 1:length(freq)
0355     plot(fax,[freq(i) freq(i)],[10^-5 0.01],<span class="string">'-c'</span>,freq(i),10^-5,<span class="string">'vc'</span>);
0356     hold(fax,<span class="string">'on'</span>);
0357 <span class="keyword">end</span>
0358 plot(fax,f,2*abs(Y(1:NFFT/2+1)).^2);
0359 hold(fax,<span class="string">'off'</span>);
0360 set(fax,<span class="string">'ylim'</span>,[0 0.01],<span class="string">'xlim'</span>,[0 max(f)],<span class="string">'yscale'</span>,<span class="string">'linear'</span>); grid(fax,<span class="string">'on'</span>);
0361 xlabel(fax,<span class="string">'Frequency (Hz)'</span>); ylabel(fax,<span class="string">''</span>); title(fax,<span class="string">'Power Spectrum'</span>)
0362 
0363 <span class="comment">% % Plot Spectrogram</span>
0364 <span class="comment">% axes(fax);</span>
0365 <span class="comment">% spectrogram(buffer,1024,512,8192,Fs,'yaxis');</span>
0366 <span class="comment">% colormap(hot)</span>
0367 <span class="comment">% set(fax,'yscale','linear','ytick',freq)</span>
0368 <span class="comment">% y = ylim(fax);</span>
0369 <span class="comment">% set(fax,'ylim',[y(1) 0.6*y(2)]);</span>
0370 
0371 
0372 
0373 
0374 
0375 
0376 
0377 
0378 
0379 
0380 
0381 
0382 
0383 
0384 
0385 
0386 
0387 <span class="comment">% Calibration functions --------------------------</span>
0388 <a name="_sub10" href="#_subfunctions" class="code">function buffer = GetBuffer(AcqRP,Fs,bdur)</a>
0389 <span class="comment">% pause(0.02);</span>
0390 
0391 <span class="keyword">if</span> ~exist(<span class="string">'bdur'</span>,<span class="string">'var'</span>) || isempty(bdur)
0392     bdur = 0.1;
0393 <span class="keyword">end</span>
0394 
0395 buffersize = floor(bdur*Fs);
0396 AcqRP.SetTagVal(<span class="string">'bufferSize'</span>,buffersize);
0397 AcqRP.ZeroTag(<span class="string">'buffer'</span>);
0398 
0399 AcqRP.SoftTrg(1);
0400 
0401 <span class="comment">% wait for buffer to be filled</span>
0402 pause(bdur+0.1);
0403 
0404 <span class="comment">% retrieve buffer</span>
0405 buffer = AcqRP.ReadTagV(<span class="string">'buffer'</span>,0,buffersize);
0406 
0407 buffer = <a href="#_sub7" class="code" title="subfunction fbuffer = FilterBuffer(buffer,Fs)">FilterBuffer</a>(buffer,Fs);
0408 
0409 <span class="comment">% get rid of transient which may occur within first 5 ms of signal</span>
0410 <span class="keyword">if</span> bdur &gt; 0.05
0411     t = round(Fs*0.01);
0412     buffer = buffer(t+1:end);
0413 <span class="keyword">end</span>
0414 
0415 <span class="keyword">if</span> isempty(buffer) || ~any(buffer)
0416     <a href="#_sub15" class="code" title="subfunction CloseConnection(StimRP,AcqRP)">CloseConnection</a>(StimRP,AcqRP);
0417     error(<span class="string">'CalibrationUtil:ACQUISITION ERROR:Empty Buffer'</span>);
0418 <span class="keyword">end</span>
0419 
0420 <a name="_sub11" href="#_subfunctions" class="code">function ref_piston_phone_Callback(hObj, ~, h) </a><span class="comment">%#ok&lt;DEFNU&gt;</span>
0421 <span class="comment">% Use acquisition module to obtain reference from a calibrated source such</span>
0422 <span class="comment">% as a piston phone.</span>
0423 <span class="comment">% set(hObj,'Enable','off'); drawnow</span>
0424 cfg = <a href="#_sub5" class="code" title="subfunction cfg = GatherCFG(h)">GatherCFG</a>(h);
0425 <span class="keyword">if</span> isequal(cfg.acq.mod,<span class="string">'RX6'</span>)
0426     cfg.acq.rpfile = which(<span class="string">'ACQ_Calibration_RX6.rcx'</span>);
0427 <span class="keyword">elseif</span> isequal(cfg.acq.mod,<span class="string">'RZ6'</span>)
0428     cfg.acq.rpfile = which(<span class="string">'ACQ_Calibration_RZ6.rcx'</span>);
0429 <span class="keyword">else</span>
0430     cfg.acq.rpfile = which(<span class="string">'ACQ_Calibration.rcx'</span>);
0431 <span class="keyword">end</span>
0432 cfg.acq.fsid = cfg.stim.fsid;
0433 cfg.stim = [];
0434 
0435 [~,AcqRP,Fs] = <a href="#_sub14" class="code" title="subfunction [StimRP,AcqRP,Fs] = OpenConnection(cfg)">OpenConnection</a>(cfg);
0436 
0437 fax = h.freq_domain;
0438 cax = h.calibration_curve;
0439 
0440 cfg.Fs = Fs;
0441 
0442 <span class="comment">% piston phone frequency = 250 Hz</span>
0443 freq = 250;
0444 buffer = <a href="#_sub10" class="code" title="subfunction buffer = GetBuffer(AcqRP,Fs,bdur)">GetBuffer</a>(AcqRP,Fs,1);
0445 
0446 
0447 <span class="comment">% chop off filter distortion</span>
0448 buffer(1:floor(length(buffer)/2)) = [];
0449 
0450 <span class="comment">% ANALYZE, PLOT, UPDATE CORRESPONDING FIELD</span>
0451 res = <a href="#_sub8" class="code" title="subfunction res = SignalAnalysis(buffer,ref,V)">SignalAnalysis</a>(buffer,cfg.ref,1);
0452 <span class="keyword">if</span> res.rms &gt; 9.99
0453     set(hObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0454     error(<span class="string">'CalibrationUtil:REFERENCE:Voltage out of range'</span>);
0455 <span class="keyword">end</span>
0456 set(h.ref_rms,<span class="string">'String'</span>,num2str(res.rms*1000,<span class="string">'%0.1f'</span>));
0457 
0458 cla(cax);
0459 cla(fax);
0460 
0461 <a href="#_sub9" class="code" title="subfunction PlotSignal(buffer,Fs,h,freq)">PlotSignal</a>(buffer,Fs,h,freq);
0462 
0463 <a href="#_sub15" class="code" title="subfunction CloseConnection(StimRP,AcqRP)">CloseConnection</a>([],AcqRP);
0464 set(hObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0465 
0466 
0467 <a name="_sub12" href="#_subfunctions" class="code">function [hdr,data] = CalibrateNoise(cfg,h)</a>
0468 <span class="keyword">global</span> StimRP AcqRP
0469 
0470 <span class="comment">% Runc calibration for noise type stimuli</span>
0471 ref = cfg.ref;
0472 [StimRP,AcqRP,Fs] = <a href="#_sub14" class="code" title="subfunction [StimRP,AcqRP,Fs] = OpenConnection(cfg)">OpenConnection</a>(cfg);
0473 
0474 cfg.Fs = Fs;
0475 cax = h.calibration_curve;
0476 
0477 hp = cfg.hp;
0478 lp = cfg.lp;
0479 
0480 hdr.timestamp = datestr(now);
0481 hdr.cfg = cfg;
0482 
0483 hdr.V = 10;
0484 
0485 data = nan(length(hp),4);
0486 data(:,1) = hp;
0487 data(:,2) = lp;
0488 
0489 xr = [min(hp)*2^-0.5 max(hp)*2^0.5];
0490 
0491 <span class="keyword">for</span> i = 1:length(hp)
0492         StimRP.SetTagVal(<span class="string">'HPFc'</span>,hp(i));
0493         StimRP.SetTagVal(<span class="string">'LPFc'</span>,lp(i));
0494         StimRP.SoftTrg(2);
0495         
0496         res.adjV = hdr.V; <span class="comment">% starting voltage</span>
0497         StimRP.SetTagVal(<span class="string">'Amp'</span>,res.adjV);
0498         
0499         pause(0.2);
0500         buffer = <a href="#_sub10" class="code" title="subfunction buffer = GetBuffer(AcqRP,Fs,bdur)">GetBuffer</a>(AcqRP,Fs,1);
0501         
0502         <span class="comment">% ANALYZE, PLOT, UPDATE TABLE</span>
0503         res = <a href="#_sub8" class="code" title="subfunction res = SignalAnalysis(buffer,ref,V)">SignalAnalysis</a>(buffer,cfg.ref,res.adjV);
0504         
0505         <a href="#_sub9" class="code" title="subfunction PlotSignal(buffer,Fs,h,freq)">PlotSignal</a>(buffer,Fs,h,data(i,[1 2]));
0506         tax = h.time_domain;
0507         plot(tax,linspace(0,0.1,length(buffer))*1000,buffer);
0508 
0509         <span class="comment">% Plot Calibration Function</span>
0510         plot(cax,xlim,[ref.norm ref.norm],<span class="string">'-k'</span>,<span class="string">'linewidth'</span>,2);
0511         hold(cax,<span class="string">'on'</span>);
0512         plot(cax,data(:,1),data(:,2),<span class="string">'-ob'</span>,<span class="string">'markerfacecolor'</span>,<span class="string">'b'</span>);
0513         set(cax,<span class="string">'xlim'</span>,xr,<span class="string">'ylim'</span>,[0 130]); grid(cax,<span class="string">'on'</span>);
0514         hold(cax,<span class="string">'off'</span>);
0515         data(i,3) = res.level; <span class="comment">% sound level</span>
0516         data(i,4) = res.adjV;<span class="comment">% adjusted voltage</span>
0517         
0518         <span class="comment">% Update table</span>
0519         set(h.data_table,<span class="string">'Data'</span>,num2cell(data)); drawnow
0520 <span class="keyword">end</span>
0521 <a href="#_sub15" class="code" title="subfunction CloseConnection(StimRP,AcqRP)">CloseConnection</a>(StimRP,AcqRP);
0522 
0523 
0524 <a name="_sub13" href="#_subfunctions" class="code">function [hdr,data] = CalibrateTones(cfg,h)</a>
0525 <span class="keyword">global</span> StimRP AcqRP
0526 
0527 <span class="comment">% Run calibration for tone type stimuli.</span>
0528 ref = cfg.ref;
0529 
0530 <span class="comment">% ________________</span>
0531 <span class="comment">% cd 'CalUtil_RPvds'</span>
0532 
0533 [StimRP,AcqRP,Fs] = <a href="#_sub14" class="code" title="subfunction [StimRP,AcqRP,Fs] = OpenConnection(cfg)">OpenConnection</a>(cfg);
0534 <span class="comment">% ________________</span>
0535 <span class="comment">% cd ..</span>
0536 
0537 <span class="keyword">try</span> <span class="comment">%#ok&lt;TRYNC&gt;</span>
0538     cfg.Fs = Fs;
0539     
0540     cax = h.calibration_curve;
0541     
0542     f = cfg.freqs;
0543     xr = [min(f)*2^-0.5 max(f)*2^0.5];
0544     
0545     <span class="comment">% upper/lower bounds +/- 0.5% of desired norm</span>
0546     tolerance = 0.005;
0547 <span class="comment">%     LB = ref.norm * (1-tolerance);</span>
0548 <span class="comment">%     UB = ref.norm * (1+tolerance);</span>
0549     
0550     hdr.tolerance = tolerance;
0551     hdr.timestamp = datestr(now);
0552     hdr.cfg = cfg;
0553     hdr.V = 10; <span class="comment">% starting voltage</span>
0554     
0555     data = nan(length(f),3);
0556     data(:,1) = f;
0557     
0558     <span class="keyword">for</span> i = 1:length(f)
0559         <span class="comment">% update tone frequency</span>
0560         StimRP.SetTagVal(<span class="string">'Freq'</span>,f(i));
0561         res.adjV = hdr.V; <span class="comment">% starting voltage</span>
0562         <span class="comment">%     n = 0; converge = false;</span>
0563         
0564         <span class="comment">%     while ~converge</span>
0565         StimRP.SetTagVal(<span class="string">'Amp'</span>,res.adjV);
0566         
0567         buffer = <a href="#_sub10" class="code" title="subfunction buffer = GetBuffer(AcqRP,Fs,bdur)">GetBuffer</a>(AcqRP,Fs);
0568         
0569         <span class="comment">% ANALYZE, PLOT, UPDATE TABLE</span>
0570         res = <a href="#_sub8" class="code" title="subfunction res = SignalAnalysis(buffer,ref,V)">SignalAnalysis</a>(buffer,cfg.ref,res.adjV);
0571         
0572         <a href="#_sub9" class="code" title="subfunction PlotSignal(buffer,Fs,h,freq)">PlotSignal</a>(buffer,Fs,h,f(i));
0573         
0574         <span class="comment">% Plot Calibration Function</span>
0575         plot(cax,xlim,[ref.norm ref.norm],<span class="string">'-k'</span>,<span class="string">'linewidth'</span>,2);
0576         hold(cax,<span class="string">'on'</span>);
0577         plot(cax,data(:,1),data(:,2),<span class="string">'-ob'</span>,<span class="string">'markerfacecolor'</span>,<span class="string">'b'</span>);
0578         set(cax,<span class="string">'xlim'</span>,xr,<span class="string">'ylim'</span>,[0 130]); grid(cax,<span class="string">'on'</span>);
0579         hold(cax,<span class="string">'off'</span>);
0580         
0581         <span class="comment">% test if adjusted voltage produces intended sound level</span>
0582         <span class="comment">%         converge = res.level &gt;= LB &amp; res.level &lt;= UB;</span>
0583         <span class="comment">%         n = n + 1;</span>
0584         <span class="comment">%         if n == 25</span>
0585         <span class="comment">%             CloseConnection(StimRP,AcqRP);</span>
0586         <span class="comment">%             error('CalibrationUtil:STIMULUS WARNING:Unable to converge\n')</span>
0587         <span class="comment">%         end</span>
0588         <span class="comment">%</span>
0589         <span class="comment">% test adjusted voltage is within range</span>
0590         <span class="comment">%         if res.adjV &gt; 9.99</span>
0591         <span class="comment">%             CloseConnection(StimRP,AcqRP);</span>
0592         <span class="comment">%             error('CalibrationUtil:STIMULUS ERROR:Adjusted voltage too high\n')</span>
0593         <span class="comment">%         end</span>
0594         
0595         <span class="comment">%         % Update with adjusted value</span>
0596         <span class="comment">%         StimRP.SetTagVal('Amp',res.adjV);</span>
0597         <span class="comment">%</span>
0598         <span class="comment">%         if converge, continue; end</span>
0599         
0600         data(i,2) = res.level; <span class="comment">% sound level</span>
0601         data(i,3) = res.adjV; <span class="comment">% adjusted voltage</span>
0602         
0603         <span class="comment">% Update table</span>
0604         set(h.data_table,<span class="string">'Data'</span>,num2cell(data)); drawnow
0605         <span class="comment">%     end</span>
0606         
0607     <span class="keyword">end</span>
0608 <span class="keyword">end</span>
0609 <a href="#_sub15" class="code" title="subfunction CloseConnection(StimRP,AcqRP)">CloseConnection</a>(StimRP,AcqRP);
0610 
0611 
0612 
0613 
0614 
0615 
0616 
0617 
0618 
0619 
0620 
0621 
0622 
0623 
0624 
0625 
0626 
0627 
0628 
0629 
0630 
0631 <span class="comment">% TDT Functions -------------------------------</span>
0632 <a name="_sub14" href="#_subfunctions" class="code">function [StimRP,AcqRP,Fs] = OpenConnection(cfg)</a>
0633 stim = cfg.stim;
0634 acq  = cfg.acq;
0635 StimRP = [];
0636 
0637 AcqRP = TDT_SetupRP(acq.mod,acq.modid,cfg.contype,[]);
0638 AcqRP.LoadCOFsf(acq.rpfile,acq.fsid);
0639 AcqRP.Run;
0640 
0641 <span class="keyword">if</span> ~cfg.single_mod &amp;&amp; ~isempty(stim)
0642     StimRP = TDT_SetupRP(stim.mod,stim.modid,cfg.contype,[]);
0643     StimRP.LoadCOFsf(stim.rpfile,stim.fsid);
0644     StimRP.Run;
0645 <span class="keyword">else</span>
0646     StimRP = AcqRP;
0647 <span class="keyword">end</span>
0648 
0649 
0650 
0651 Fs = AcqRP.GetSFreq;
0652 
0653     
0654 <span class="comment">% pause(0.25);</span>
0655 
0656 <a name="_sub15" href="#_subfunctions" class="code">function CloseConnection(StimRP,AcqRP)</a>
0657 <span class="keyword">if</span> ~isempty(StimRP) &amp;&amp; isa(StimRP,<span class="string">'COM.RPco_x'</span>)
0658     StimRP.ClearCOF;
0659     StimRP.Halt;
0660     delete(StimRP);
0661 <span class="keyword">end</span>
0662 
0663 <span class="keyword">if</span> ~isempty(AcqRP) &amp;&amp; isa(AcqRP,<span class="string">'COM.RPco_x'</span>)
0664     AcqRP.ClearCOF;
0665     AcqRP.Halt;
0666     delete(AcqRP);
0667 <span class="keyword">end</span>
0668 
0669 fh = findobj(<span class="string">'type'</span>,<span class="string">'figure'</span>,<span class="string">'-and'</span>,<span class="string">'name'</span>,<span class="string">'RPfig'</span>);
0670 <span class="keyword">if</span> ~isempty(fh), close(fh); <span class="keyword">end</span>
0671 
0672 
0673 
0674 
0675 
0676 
0677 
0678 <span class="comment">% Save/Load Functions --------------------------</span>
0679 <a name="_sub16" href="#_subfunctions" class="code">function SaveCalibration(hdr,data)  </a>
0680 <span class="comment">% calibration directory</span>
0681 dd = <span class="string">'C:\Electrophys\Calibrations'</span>;
0682 <span class="keyword">if</span> ~isdir(dd), mkdir(dd); <span class="keyword">end</span>
0683 [fn,pn,fidx] = uiputfile({ <span class="keyword">...</span>
0684     <span class="string">'*.cal'</span>,<span class="string">'Calibration File (*.cal)'</span>; <span class="keyword">...</span>
0685     <span class="string">'*.txt'</span>,<span class="string">'OLD FORMAT - Text File (*.txt)'</span>; <span class="keyword">...</span>
0686     <span class="string">'*.csv'</span>,<span class="string">'Comma Separated Value (*.csv)'</span>}, <span class="keyword">...</span>
0687     <span class="string">'Save Calibration'</span>,dd);
0688 
0689 <span class="keyword">if</span> ~fidx
0690     fprintf(<span class="string">'Calibration was NOT saved.\n'</span>);
0691     <span class="keyword">return</span>
0692 <span class="keyword">end</span>
0693 
0694 <span class="keyword">switch</span> fidx
0695     <span class="keyword">case</span> 1 <span class="comment">% Calibration file</span>
0696         save(fullfile(pn,fn),<span class="string">'-mat'</span>,<span class="string">'hdr'</span>,<span class="string">'data'</span>);
0697         
0698     <span class="keyword">case</span> 2 <span class="comment">% OLD FORMAT - Text file</span>
0699         <span class="keyword">if</span> isequal(hdr.calfunc,@<a href="#_sub13" class="code" title="subfunction [hdr,data] = CalibrateTones(cfg,h)">CalibrateTones</a>)
0700             tmat(1,1) = -1; tmat(1,2) = hdr.V;
0701             tmat(2:size(data,1)+1,:) = data(:,[1 2]);
0702             dlmwrite(fullfile(pn,fn),tmat,<span class="string">'delimiter'</span>,<span class="string">','</span>,<span class="string">'newline'</span>,<span class="string">'pc'</span>);
0703             
0704         <span class="keyword">elseif</span> isequal(hdr.calfunc,@<a href="#_sub12" class="code" title="subfunction [hdr,data] = CalibrateNoise(cfg,h)">CalibrateNoise</a>)
0705             tmat(1,1:2) = -1; tmat(1,3) = hdr.V;
0706             tmat(2:size(data,1)+1,:) = data(:,[1 2 3]);
0707             dlmwrite(fullfile(pn,fn),tmat,<span class="string">'delimiter'</span>,<span class="string">','</span>,<span class="string">'newline'</span>,<span class="string">'pc'</span>);
0708         <span class="keyword">end</span>
0709         
0710     <span class="keyword">case</span> 3 <span class="comment">% CSV file</span>
0711         dlmwrite(fullfile(pn,fn),data,<span class="string">'delimiter'</span>,<span class="string">','</span>,<span class="string">'newline'</span>,<span class="string">'pc'</span>);
0712 <span class="keyword">end</span>
0713 
0714 fprintf(<span class="string">'File Saved: %s\n'</span>,fullfile(pn,fn));</pre></div>
<hr><address>Generated on Wed 24-Jul-2013 19:48:12 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>